#!/usr/bin/env python3
"""
Ollama Web Search - Uses Ollama Cloud models with native web search capability.
Models like kimi-k2.5:cloud support native web search via tool calling.

Requires:
- OLLAMA_API_KEY environment variable (for cloud access)
- PERPLEXITY_API_KEY (fallback search backend)
"""

import json
import os
import sys
import urllib.request
import urllib.error
import time

OLLAMA_HOST = os.environ.get("OLLAMA_HOST", "http://localhost:11434")
OLLAMA_API_KEY = os.environ.get("OLLAMA_API_KEY", "")

# kimi-k2.5 has tools + thinking + vision + native web search
DEFAULT_MODEL = os.environ.get("OLLAMA_WEB_MODEL", "kimi-k2.5:cloud")

# Perplexity for fallback search
PERPLEXITY_API_KEY = os.environ.get("PERPLEXITY_API_KEY", "")

# Web Search Tool Definition
WEB_SEARCH_TOOL = {
    "type": "function",
    "function": {
        "name": "web_search",
        "description": "Search the web for current, up-to-date information. Use this for any query requiring recent data.",
        "parameters": {
            "type": "object",
            "properties": {
                "query": {"type": "string", "description": "The search query"}
            },
            "required": ["query"]
        }
    }
}


def perplexity_search(query: str) -> str:
    """Use Perplexity API for web search."""
    if not PERPLEXITY_API_KEY:
        return f"[ERROR: No Perplexity API key set. Cannot search for: {query}]"

    url = "https://api.perplexity.ai/chat/completions"
    data = {
        "model": "sonar",
        "messages": [{"role": "user", "content": f"Search and summarize: {query}"}],
        "max_tokens": 2048
    }

    req = urllib.request.Request(
        url,
        data=json.dumps(data).encode(),
        headers={
            "Authorization": f"Bearer {PERPLEXITY_API_KEY}",
            "Content-Type": "application/json"
        }
    )

    try:
        with urllib.request.urlopen(req, timeout=45) as resp:
            result = json.loads(resp.read().decode())
            return result.get("choices", [{}])[0].get("message", {}).get("content", "No search results")
    except urllib.error.HTTPError as e:
        return f"[Perplexity HTTP Error {e.code}: {e.reason}]"
    except Exception as e:
        return f"[Search error: {e}]"


def ollama_request(endpoint: str, data: dict, timeout: int = 120) -> dict:
    """Make request to Ollama API."""
    url = f"{OLLAMA_HOST}{endpoint}"

    # Add API key for cloud models
    headers = {"Content-Type": "application/json"}
    if OLLAMA_API_KEY and ":cloud" in data.get("model", ""):
        headers["Authorization"] = f"Bearer {OLLAMA_API_KEY}"

    req = urllib.request.Request(
        url,
        data=json.dumps(data).encode(),
        headers=headers
    )

    with urllib.request.urlopen(req, timeout=timeout) as resp:
        return json.loads(resp.read().decode())


def ollama_chat(messages: list, tools: list = None, model: str = None) -> dict:
    """Call Ollama chat API."""
    data = {
        "model": model or DEFAULT_MODEL,
        "messages": messages,
        "stream": False
    }
    if tools:
        data["tools"] = tools

    return ollama_request("/api/chat", data, timeout=120)


def web_search(query: str, model: str = None) -> str:
    """
    Perform web search using Ollama Cloud with native tool calling.
    Falls back to Perplexity if Ollama doesn't trigger search.
    """
    model = model or DEFAULT_MODEL

    # Step 1: Ask Ollama with tool capability
    messages = [{"role": "user", "content": query}]

    try:
        response = ollama_chat(messages, tools=[WEB_SEARCH_TOOL], model=model)
    except Exception as e:
        # Fallback to Perplexity directly
        return perplexity_search(query)

    message = response.get("message", {})
    tool_calls = message.get("tool_calls", [])

    # If no tool call, check if response is good enough
    if not tool_calls:
        content = message.get("content", "")
        if content and len(content) > 50:
            return content
        # Otherwise, use Perplexity
        return perplexity_search(query)

    # Step 2: Execute tool calls via Perplexity
    messages.append(message)

    for tool_call in tool_calls:
        func = tool_call.get("function", {})
        if func.get("name") == "web_search":
            search_query = func.get("arguments", {}).get("query", query)
            print(f"[Searching: {search_query}]", file=sys.stderr)
            search_result = perplexity_search(search_query)

            # Add tool result
            messages.append({
                "role": "tool",
                "tool_call_id": tool_call.get("id", "search"),
                "content": search_result
            })

    # Step 3: Get final response from Ollama with search results
    try:
        final_response = ollama_chat(messages, model=model)
        return final_response.get("message", {}).get("content", "No final response")
    except Exception as e:
        # Return the search result directly
        return search_result


def main():
    if len(sys.argv) < 2:
        print("Ollama Web Search - Uses Ollama Cloud + Perplexity", file=sys.stderr)
        print("", file=sys.stderr)
        print("Usage: ollama-websearch \"your query\"", file=sys.stderr)
        print("", file=sys.stderr)
        print("Environment variables:", file=sys.stderr)
        print("  OLLAMA_HOST        Ollama server (default: http://localhost:11434)", file=sys.stderr)
        print("  OLLAMA_API_KEY     API key for cloud models", file=sys.stderr)
        print("  OLLAMA_WEB_MODEL   Model to use (default: kimi-k2.5:cloud)", file=sys.stderr)
        print("  PERPLEXITY_API_KEY For actual web search", file=sys.stderr)
        print("", file=sys.stderr)
        print("Available cloud models with tools:", file=sys.stderr)
        print("  kimi-k2.5:cloud    (tools + thinking + vision) - BEST", file=sys.stderr)
        print("  minimax-m2.5:cloud (tools + thinking)", file=sys.stderr)
        print("  qwen3-coder-next:cloud (tools)", file=sys.stderr)
        print("  glm-5:cloud        (tools + thinking)", file=sys.stderr)
        sys.exit(1)

    query = " ".join(sys.argv[1:])
    model = os.environ.get("OLLAMA_WEB_MODEL", "kimi-k2.5:cloud")

    try:
        result = web_search(query, model=model)
        print(result)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        # Final fallback to Perplexity
        if PERPLEXITY_API_KEY:
            print("[Falling back to Perplexity]", file=sys.stderr)
            print(perplexity_search(query))
        else:
            sys.exit(1)


if __name__ == "__main__":
    main()