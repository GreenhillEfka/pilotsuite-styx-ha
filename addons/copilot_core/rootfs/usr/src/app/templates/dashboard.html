<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PilotSuite — Styx</title>
<style>
:root{--bg:#0a0e14;--surface:#12171f;--card:#171d27;--border:#1e2a3a;--text:#e0e6ed;--dim:#6b7a8d;--accent:#7c6aef;--accent2:#9b8afb;--green:#34d399;--yellow:#fbbf24;--red:#f87171;--blue:#60a5fa;--cyan:#22d3ee;--orange:#fb923c;--pink:#f472b6;--radius:12px;--shadow:0 4px 20px rgba(0,0,0,.5)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
a{color:var(--blue);text-decoration:none}a:hover{text-decoration:underline}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Header */
.header{background:linear-gradient(180deg,var(--surface) 0%,rgba(18,23,31,.95) 100%);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100;backdrop-filter:blur(12px)}
.header .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#5b4cd4);display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 2px 12px rgba(124,106,239,.3)}
.header h1{font-size:18px;font-weight:700;flex:1;background:linear-gradient(135deg,var(--accent2),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header .status-pill{display:flex;align-items:center;gap:6px;font-size:12px;padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:var(--card)}
.header .dot{width:7px;height:7px;border-radius:50%;animation:pulse 2s infinite}
.dot-green{background:var(--green)}.dot-yellow{background:var(--yellow)}.dot-red{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.header .ver{font-size:11px;color:var(--dim);padding:3px 8px;border-radius:12px;border:1px solid var(--border)}

/* Nav */
.nav{background:var(--surface);border-bottom:1px solid var(--border);display:flex;overflow-x:auto;padding:0 12px;gap:2px}
.nav button{background:none;border:none;color:var(--dim);padding:10px 16px;font-size:12px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:.2s;letter-spacing:.3px;text-transform:uppercase}
.nav button:hover{color:var(--text)}.nav button.active{color:var(--accent2);border-bottom-color:var(--accent)}

/* Layout */
.page{display:none;padding:16px;max-width:1600px;margin:0 auto}.page.active{display:block}
.grid{display:grid;gap:14px}.g2{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}.g3{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}.g4{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);transition:border-color .2s}
.card:hover{border-color:rgba(124,106,239,.3)}
.card h2{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:7px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.card h2 .ic{font-size:16px}

/* Stat */
.stat{text-align:center;padding:12px 8px}.stat .v{font-size:32px;font-weight:800;background:linear-gradient(135deg,var(--accent2),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.stat .l{font-size:10px;color:var(--dim);margin-top:3px;text-transform:uppercase;letter-spacing:.8px}

/* Badge */
.b{display:inline-block;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:600;letter-spacing:.3px}
.b-g{background:rgba(52,211,153,.12);color:var(--green)}.b-y{background:rgba(251,191,36,.12);color:var(--yellow)}
.b-r{background:rgba(248,113,113,.12);color:var(--red)}.b-b{background:rgba(96,165,250,.12);color:var(--blue)}
.b-p{background:rgba(124,106,239,.12);color:var(--accent2)}.b-c{background:rgba(34,211,238,.12);color:var(--cyan)}

/* Table */
.tbl{width:100%;border-collapse:collapse;font-size:12px}
.tbl th{text-align:left;padding:6px 10px;color:var(--dim);font-weight:500;border-bottom:1px solid var(--border);font-size:10px;text-transform:uppercase;letter-spacing:.5px}
.tbl td{padding:7px 10px;border-bottom:1px solid rgba(30,42,58,.5)}

/* Gauge */
.gauge{margin:6px 0}.gauge-hd{display:flex;justify-content:space-between;font-size:11px;color:var(--dim);margin-bottom:3px}
.gauge-hd .gv{color:var(--text);font-weight:600}
.gauge-bar{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.gauge-fill{height:100%;border-radius:3px;transition:width .8s ease}

/* Pattern */
.pat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin:6px 0;display:flex;align-items:center;gap:10px;font-size:12px}
.pat .arr{color:var(--accent2);font-weight:700;flex-shrink:0}.pat .meta{margin-left:auto;color:var(--dim);font-size:11px;white-space:nowrap}

/* ============== STYX PAGE: Brain + Chat + History ============== */
.styx-layout{display:grid;grid-template-columns:1fr 380px;grid-template-rows:auto 1fr auto;gap:14px;height:calc(100vh - 120px);min-height:500px}
.styx-brain{grid-column:1;grid-row:1/4;display:flex;flex-direction:column;gap:12px}
.styx-right{grid-column:2;grid-row:1/4;display:flex;flex-direction:column;gap:12px;min-height:0}

/* Brain container */
.brain-wrap{flex:1;min-height:300px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);position:relative;overflow:hidden}
.brain-wrap svg{width:100%;height:100%;display:block}
.brain-legend{position:absolute;top:10px;left:10px;display:flex;flex-wrap:wrap;gap:6px;z-index:5}
.brain-legend .leg{font-size:9px;display:flex;align-items:center;gap:4px;background:rgba(10,14,20,.8);padding:3px 8px;border-radius:6px;border:1px solid var(--border)}
.brain-legend .leg .dot-lg{width:8px;height:8px;border-radius:50%}
.brain-controls{position:absolute;top:10px;right:10px;display:flex;gap:4px;z-index:5}
.brain-controls button{background:var(--card);border:1px solid var(--border);color:var(--dim);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:12px}
.brain-controls button:hover{color:var(--text);border-color:var(--accent)}

/* Module pipeline indicators */
.pipelines{display:flex;gap:6px;flex-wrap:wrap;padding:4px 0}
.pipe{display:flex;align-items:center;gap:5px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:10px;cursor:pointer;transition:.2s}
.pipe:hover{border-color:var(--accent)}
.pipe .pd{width:6px;height:6px;border-radius:50%}
.pipe-active .pd{background:var(--green)}.pipe-learning .pd{background:var(--yellow);animation:pulse 1.5s infinite}.pipe-off .pd{background:var(--dim)}
.pipe-error .pd{background:var(--red)}.pipe-unknown .pd{background:var(--dim);opacity:.4}
.pipe span{color:var(--dim)}.pipe-active span{color:var(--green)}.pipe-learning span{color:var(--yellow)}
.pipe-error span{color:var(--red)}.pipe-unknown span{color:var(--dim);opacity:.5}

/* Chat panel */
.chat-panel{display:flex;flex-direction:column;flex:1;min-height:0;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.chat-hd{padding:10px 14px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;display:flex;align-items:center;gap:8px;color:var(--accent2);flex-shrink:0}
.chat-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;min-height:0}
.msg{max-width:85%;padding:8px 12px;border-radius:10px;font-size:13px;line-height:1.5;word-wrap:break-word}
.msg.u{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#5b4cd4);color:#fff;border-bottom-right-radius:3px}
.msg.a{align-self:flex-start;background:var(--surface);border:1px solid var(--border);border-bottom-left-radius:3px}
.chat-in{display:flex;gap:6px;padding:10px;border-top:1px solid var(--border);flex-shrink:0}
.chat-in input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-size:13px;outline:none}
.chat-in input:focus{border-color:var(--accent)}
.chat-in button{background:linear-gradient(135deg,var(--accent),#5b4cd4);color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:12px;font-weight:600}
.chat-in button:disabled{opacity:.4;cursor:not-allowed}

/* History panel */
.history-panel{max-height:180px;overflow-y:auto;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);flex-shrink:0}
.history-panel .hd{padding:8px 14px;font-size:11px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--card);z-index:1}
.hist-item{padding:6px 14px;font-size:11px;border-bottom:1px solid rgba(30,42,58,.3);display:flex;gap:8px;align-items:center}
.hist-item .ht{color:var(--dim);font-size:10px;flex-shrink:0;width:40px}

/* Suggestions bar (legacy compat) */
.suggest-bar{display:flex;gap:8px;overflow-x:auto;padding:8px 0;flex-shrink:0}
.suggest-btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:6px 14px;border-radius:20px;font-size:11px;cursor:pointer;white-space:nowrap;transition:.2s}
.suggest-btn:hover{border-color:var(--accent);background:rgba(124,106,239,.08)}

/* Suggestion Inbox */
.sugg-inbox{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);flex-shrink:0;max-height:260px;display:flex;flex-direction:column}
.sugg-inbox .sugg-hd{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;border-bottom:1px solid var(--border);font-size:11px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;flex-shrink:0}
.sugg-inbox .sugg-hd .sugg-count{font-size:10px;color:var(--accent2);font-weight:700}
.sugg-batch{display:flex;gap:6px;align-items:center}
.sugg-batch button{background:none;border:1px solid var(--border);color:var(--dim);padding:3px 10px;border-radius:6px;font-size:10px;cursor:pointer;transition:.2s}
.sugg-batch button:hover{border-color:var(--accent);color:var(--text)}
.sugg-batch .sugg-accept-all{border-color:rgba(52,211,153,.3);color:var(--green)}
.sugg-batch .sugg-accept-all:hover{background:rgba(52,211,153,.1);border-color:var(--green)}
.sugg-batch .sugg-reject-all{border-color:rgba(248,113,113,.3);color:var(--red)}
.sugg-batch .sugg-reject-all:hover{background:rgba(248,113,113,.1);border-color:var(--red)}
.sugg-list{overflow-y:auto;flex:1;min-height:0}
.sugg-item{display:flex;align-items:center;gap:8px;padding:7px 14px;border-bottom:1px solid rgba(30,42,58,.3);font-size:12px;transition:background .15s}
.sugg-item:hover{background:rgba(124,106,239,.04)}
.sugg-item.accepted{background:rgba(52,211,153,.06);opacity:.7}
.sugg-item.rejected{background:rgba(248,113,113,.04);opacity:.4;text-decoration:line-through}
.sugg-check{width:14px;height:14px;border-radius:3px;border:1.5px solid var(--border);background:none;cursor:pointer;flex-shrink:0;transition:.2s;appearance:none;-webkit-appearance:none}
.sugg-check:checked{background:var(--accent);border-color:var(--accent)}
.sugg-check:checked::after{content:'\2713';color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center}
.sugg-body{flex:1;min-width:0}
.sugg-rule{display:flex;align-items:center;gap:5px;font-size:12px}
.sugg-rule .arr{color:var(--accent2);font-weight:700}
.sugg-zone{font-size:9px;color:var(--dim);margin-top:2px;display:flex;gap:4px;align-items:center}
.sugg-zone .zone-tag{background:rgba(34,211,238,.08);color:var(--cyan);padding:1px 6px;border-radius:4px;font-size:9px}
.sugg-conf{font-size:10px;color:var(--dim);white-space:nowrap;flex-shrink:0;width:40px;text-align:right}
.sugg-actions{display:flex;gap:4px;flex-shrink:0}
.sugg-act{width:24px;height:24px;border-radius:6px;border:1px solid var(--border);background:none;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:.2s;color:var(--dim)}
.sugg-act.accept:hover{background:rgba(52,211,153,.15);border-color:var(--green);color:var(--green)}
.sugg-act.reject:hover{background:rgba(248,113,113,.1);border-color:var(--red);color:var(--red)}
.sugg-empty{text-align:center;padding:20px;color:var(--dim);font-size:11px}

/* Brain edge animation */
@keyframes edgePulse{0%{stroke-opacity:0;stroke-width:0}30%{stroke-opacity:1;stroke-width:4}100%{stroke-opacity:.4;stroke-width:1.5}}
.brain-edge-new{animation:edgePulse 1.2s ease-out forwards;stroke:var(--green);filter:url(#glow)}

/* ============== MODULE PAGE ============== */
.mod-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;display:flex;align-items:center;gap:12px}
.mod-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.mod-info{flex:1;min-width:0}.mod-info h3{font-size:13px;font-weight:600}.mod-info p{font-size:11px;color:var(--dim);margin-top:2px}
.mod-status{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.mod-toggle{width:36px;height:20px;border-radius:10px;border:none;cursor:pointer;position:relative;transition:.2s}
.mod-toggle.on{background:var(--green)}.mod-toggle.learn{background:var(--yellow)}.mod-toggle.off{background:var(--dim)}
.mod-toggle::after{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;top:2px;transition:.2s}
.mod-toggle.on::after,.mod-toggle.learn::after{left:18px}.mod-toggle.off::after{left:2px}

/* ============== HABITUS PAGE ============== */
.zone-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.zone-card h3{font-size:14px;font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.zone-entities{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
.zone-entities .ze{font-size:10px;background:var(--surface);border:1px solid var(--border);padding:3px 8px;border-radius:6px;color:var(--dim)}

/* ============== TREND CHART ============== */
.trend-chart{width:100%;height:120px;position:relative}
.trend-chart canvas{width:100%;height:100%}

/* Loading / Empty */
.loading{display:flex;align-items:center;justify-content:center;padding:30px;color:var(--dim);font-size:12px}
.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:30px;color:var(--dim);font-size:12px;line-height:1.6}

/* Responsive */
@media(max-width:900px){
  .styx-layout{grid-template-columns:1fr;grid-template-rows:auto auto auto;height:auto}
  .styx-brain{grid-column:1;grid-row:1}
  .styx-right{grid-column:1;grid-row:2/4}
  .brain-wrap{min-height:250px}
}
@media(max-width:600px){.g2,.g3,.g4{grid-template-columns:1fr}.header h1{font-size:15px}}

/* Onboard */
.onboard{background:linear-gradient(135deg,rgba(124,106,239,.08),rgba(34,211,238,.05));border:1px solid rgba(124,106,239,.25);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.onboard h2{font-size:16px;font-weight:700;margin-bottom:6px;background:linear-gradient(135deg,var(--accent2),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.onboard p{color:var(--dim);font-size:13px;line-height:1.6}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
<div class="logo">&#x2726;</div>
<h1 id="app-title">Styx — PilotSuite</h1>
<span class="status-pill" id="provider-status"><span class="dot dot-yellow" id="status-dot"></span><span id="status-text">Verbinde...</span></span>
<span class="ver" id="ver-badge">v1.0.0</span>
</div>

<!-- Navigation -->
<div class="nav" id="nav">
<button class="active" data-page="styx">Styx</button>
<button data-page="habitus">Habitus</button>
<button data-page="mood">Stimmung</button>
<button data-page="modules">Module</button>
<button data-page="settings">Einstellungen</button>
</div>

<!-- ========== STYX PAGE: Brain + Chat + History ========== -->
<div class="page active" id="page-styx">
<!-- Module Pipelines -->
<div class="pipelines" id="pipelines"></div>
<!-- Main Layout -->
<div class="styx-layout">
  <!-- LEFT: Brain Graph -->
  <div class="styx-brain">
    <div class="brain-wrap" id="brain-canvas">
      <div class="brain-legend" id="brain-legend"></div>
      <div class="brain-controls"><button onclick="reloadBrain()" title="Neu laden">&#x21bb;</button></div>
      <div class="loading"><div class="spinner"></div>Brain Graph laden...</div>
    </div>
    <!-- Suggestion Inbox -->
    <div class="sugg-inbox" id="sugg-inbox">
      <div class="sugg-hd">
        <span>Vorschlaege <span class="sugg-count" id="sugg-count">0</span></span>
        <div class="sugg-batch" id="sugg-batch" style="display:none">
          <button class="sugg-accept-all" onclick="batchAccept()" title="Alle markierten annehmen">&#x2713; Annehmen</button>
          <button class="sugg-reject-all" onclick="batchReject()" title="Alle markierten ablehnen">&#x2717; Ablehnen</button>
        </div>
      </div>
      <div class="sugg-list" id="sugg-list">
        <div class="sugg-empty">Lade Vorschlaege...</div>
      </div>
    </div>
    <!-- Quick navigation -->
    <div class="suggest-bar">
      <span class="suggest-btn" onclick="navigateTo('habitus')">Habitus erkunden</span>
      <span class="suggest-btn" onclick="navigateTo('mood')">Stimmung pruefen</span>
      <span class="suggest-btn" onclick="navigateTo('modules')">Module verwalten</span>
    </div>
  </div>
  <!-- RIGHT: Chat + History -->
  <div class="styx-right">
    <!-- Chat -->
    <div class="chat-panel">
      <div class="chat-hd"><span>&#x2726;</span> <span id="assistant-name">Styx</span> <span class="b b-p" id="chat-model">--</span></div>
      <div class="chat-msgs" id="chat-msgs">
        <div class="msg a" id="styx-greeting">Hallo! Ich bin <strong>Styx</strong>, dein PilotSuite Assistent. Ich verbinde dein Smart Home mit lokaler KI. Wie kann ich helfen?</div>
      </div>
      <div class="chat-in">
        <input type="text" id="chat-input" placeholder="Frag Styx..." autocomplete="off">
        <button id="chat-send" onclick="sendChat()">&#x2728;</button>
      </div>
    </div>
    <!-- History -->
    <div class="history-panel" id="history-panel">
      <div class="hd">Verlauf &amp; Aktivitaet</div>
      <div id="history-items"><div class="hist-item"><span class="ht">jetzt</span><span>PilotSuite gestartet</span></div></div>
    </div>
  </div>
</div>
</div>

<!-- ========== HABITUS PAGE ========== -->
<div class="page" id="page-habitus">
<div class="grid g2" style="margin-bottom:14px">
  <div class="card">
    <h2><span class="ic">&#x1f50d;</span> Verhaltens-Muster</h2>
    <div class="b b-b" id="hab-count" style="margin-bottom:10px">-- Regeln</div>
    <div id="hab-rules"><div class="loading"><div class="spinner"></div>Lade...</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f3e0;</span> Habitus-Zonen</h2>
    <div id="hab-zones"><div class="loading"><div class="spinner"></div>Lade Zonen...</div></div>
    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
      <div style="font-size:11px;color:var(--dim);margin-bottom:6px">Zone hinzufuegen</div>
      <div style="display:flex;gap:6px">
        <input type="text" id="new-zone-name" placeholder="Zonen-Name" style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text);font-size:12px;outline:none">
        <input type="text" id="new-zone-entities" placeholder="entity_id, entity_id, ..." style="flex:2;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text);font-size:12px;outline:none">
        <button onclick="addZone()" style="background:var(--accent);color:#fff;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap">+ Zone</button>
      </div>
    </div>
  </div>
</div>
<div class="card">
  <h2><span class="ic">&#x1f4c8;</span> Pattern Trend (letzte 24h)</h2>
  <div class="trend-chart" id="hab-trend"><canvas id="hab-trend-canvas"></canvas></div>
</div>
</div>

<!-- ========== MOOD PAGE ========== -->
<div class="page" id="page-mood">
<div class="card" style="margin-bottom:14px">
  <h2><span class="ic">&#x1f3b5;</span> Stimmungs-Zonen</h2>
  <div id="mood-zones"><div class="loading"><div class="spinner"></div>Lade...</div></div>
</div>
<div class="grid g3" id="mood-stats"></div>
<div class="card" style="margin-top:14px">
  <h2><span class="ic">&#x1f4ca;</span> Mood Trend</h2>
  <div class="trend-chart" id="mood-trend"><canvas id="mood-trend-canvas"></canvas></div>
</div>
</div>

<!-- ========== MODULES PAGE ========== -->
<div class="page" id="page-modules">
<div class="card" style="margin-bottom:14px">
  <h2><span class="ic">&#x2699;&#xfe0f;</span> Neurale Pipeline</h2>
  <p style="font-size:12px;color:var(--dim);margin-bottom:12px">Module steuern wie Styx dein Zuhause wahrnimmt. Aktive Module lernen automatisch, lernende Module fragen nach.</p>
</div>
<div class="grid g2" id="module-list"></div>
</div>

<!-- ========== SETTINGS PAGE ========== -->
<div class="page" id="page-settings">
<div class="grid g2">
  <div class="card">
    <h2><span class="ic">&#x1f9e0;</span> LLM &amp; KI</h2>
    <table class="tbl" id="set-llm"></table>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f4e6;</span> Ollama Modelle</h2>
    <div id="set-models"><div class="loading"><div class="spinner"></div>Lade...</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f4f1;</span> System Status</h2>
    <table class="tbl" id="set-system"></table>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f517;</span> API Endpoints</h2>
    <table class="tbl">
      <tr><td>Chat (OpenAI)</td><td><code>/v1/chat/completions</code></td></tr>
      <tr><td>Modelle</td><td><code>/v1/models</code></td></tr>
      <tr><td>MCP Server</td><td><code>/mcp</code></td></tr>
      <tr><td>Brain Graph</td><td><code>/api/v1/graph/state</code></td></tr>
      <tr><td>Habitus</td><td><code>/api/v1/habitus/rules</code></td></tr>
      <tr><td>Vorschlaege</td><td><code>/api/v1/hints</code></td></tr>
      <tr><td>Kandidaten</td><td><code>/api/v1/candidates</code></td></tr>
      <tr><td>Mood</td><td><code>/api/v1/mood/state</code></td></tr>
      <tr><td>Neuronen</td><td><code>/api/v1/neurons</code></td></tr>
      <tr><td>Telegram</td><td><code>/telegram/status</code></td></tr>
      <tr><td>API Docs</td><td><a href="/api/v1/docs/" target="_blank">/api/v1/docs/</a></td></tr>
    </table>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f4da;</span> Gedaechtnis</h2>
    <div id="set-memory"><div class="loading"><div class="spinner"></div>Lade...</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f916;</span> Empfohlene Modelle</h2>
    <div id="set-rec"><div class="loading"><div class="spinner"></div>Lade...</div></div>
  </div>
</div>
</div>

<script>
// ==================================================
// PilotSuite Dashboard — Styx v1.2.0
// XSS-safe | Resilient | Real Module Health
// ==================================================
const API='';
let currentModel='';
const DOMAIN_COLORS={
  sensor:'#34d399',light:'#fbbf24',switch:'#7c6aef',binary_sensor:'#60a5fa',
  climate:'#f87171',media_player:'#fb923c',automation:'#9b8afb',camera:'#f472b6',
  cover:'#22d3ee',fan:'#34d399',input_boolean:'#818cf8',script:'#a78bfa',
  person:'#fbbf24',weather:'#60a5fa',scene:'#f472b6',default:'#6b7a8d'
};
const MODULE_DEFS=[
  {id:'brain_graph',name:'Brain Graph',desc:'Entity-Beziehungen erkennen',icon:'&#x1f9e0;',color:'var(--accent)'},
  {id:'habitus_miner',name:'Habitus Miner',desc:'A->B Muster finden',icon:'&#x1f50d;',color:'var(--cyan)'},
  {id:'mood_engine',name:'Mood Engine',desc:'Comfort/Joy/Frugality bewerten',icon:'&#x1f3b5;',color:'var(--yellow)'},
  {id:'event_forwarder',name:'Event Forwarder',desc:'HA-Events an Core weiterleiten',icon:'&#x26a1;',color:'var(--green)'},
  {id:'neurons',name:'Neuronen (14x)',desc:'Kontext-Signale (Presence, Energy...)',icon:'&#x1f4a1;',color:'var(--orange)'},
  {id:'knowledge_graph',name:'Knowledge Graph',desc:'Semantisches Entity-Netzwerk',icon:'&#x1f310;',color:'var(--blue)'},
  {id:'conversation_memory',name:'Gedaechtnis',desc:'Lifelong Learning SQLite',icon:'&#x1f4da;',color:'var(--pink)'},
  {id:'media_context',name:'Media Context',desc:'Musik/TV/Sonos Tracking',icon:'&#x1f3b6;',color:'var(--orange)'},
  {id:'energy_context',name:'Energy Monitor',desc:'PV, Grid, Verbrauch',icon:'&#x26a1;',color:'var(--green)'},
  {id:'weather_context',name:'Wetter',desc:'Wetter-Integration',icon:'&#x26c5;',color:'var(--blue)'},
  {id:'unifi_context',name:'UniFi Netzwerk',desc:'WLAN-Qualitaet, Praesenz',icon:'&#x1f4f6;',color:'var(--cyan)'},
  {id:'camera_context',name:'Kamera',desc:'Bewegung & Praesenz',icon:'&#x1f4f7;',color:'var(--pink)'},
  {id:'user_preferences',name:'Nutzer-Praeferenzen',desc:'Multi-User Learning (MUPL)',icon:'&#x1f464;',color:'var(--accent2)'},
  {id:'telegram_bot',name:'Telegram Bot',desc:'Chat-Bridge + Notifications',icon:'&#x2709;',color:'var(--blue)'},
  {id:'mcp_server',name:'MCP Server',desc:'Skills fuer externe KI-Clients',icon:'&#x1f50c;',color:'var(--accent)'},
];

// State
let chatHistory=[];
let historyLog=[];
let moduleStates=JSON.parse(localStorage.getItem('styx_module_states')||'{}');
let _moduleHealth=null;
let _healthTs=0;

// -- Helpers --
function $(id){return document.getElementById(id)}
function escapeHtml(s){if(s===null||s===undefined)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
async function api(path){try{const r=await fetch(API+path);if(!r.ok)return null;return await r.json()}catch(e){return null}}
function badge(t,c){return`<span class="b b-${c}">${escapeHtml(t)}</span>`}
function el(tag,cls,html){const e=document.createElement(tag);if(cls)e.className=cls;if(html)e.innerHTML=html;return e}

// -- Real Module Health (cached 30s) --
async function fetchModuleHealth(){
  const now=Date.now();
  if(_moduleHealth&&(now-_healthTs)<30000)return _moduleHealth;
  const settled=await Promise.allSettled([
    api('/api/v1/graph/stats'),         // [0] brain_graph
    api('/api/v1/habitus/health'),       // [1] habitus_miner
    api('/api/v1/mood/state'),           // [2] mood_engine
    api('/chat/status'),                 // [3] general + event_forwarder
    api('/api/v1/neurons'),              // [4] neurons
    api('/chat/memory'),                 // [5] conversation_memory
    api('/api/v1/energy/health'),        // [6] energy_context
    api('/api/v1/weather/health'),       // [7] weather_context
    api('/api/v1/unifi/health'),         // [8] unifi_context
    api('/telegram/status'),             // [9] telegram_bot
    api('/api/v1/capabilities'),         // [10] mcp_server, kg, user_prefs
  ]);
  const v=r=>r.status==='fulfilled'?r.value:null;
  const [gr,hr,mr,sr,nr,memr,er,wr,ur,tgr,capr]=settled.map(v);
  const caps=capr?.capabilities||[];
  const feats=capr?.features||{};
  const neurons=(nr?.neurons||nr?.data||[]);
  _moduleHealth={
    brain_graph:  gr?.ok&&(gr?.stats?.nodes||gr?.nodes_total||0)>0?'active':gr?.ok?'learning':'off',
    habitus_miner:hr?.status==='ok'?'active':hr?'learning':'off',
    mood_engine:  mr?.zones&&Object.keys(mr.zones||{}).length>0?'active':mr?'learning':'off',
    event_forwarder:sr?.available?'active':'off',
    neurons:      neurons.length>0?'active':'learning',
    knowledge_graph:caps.includes('knowledge_graph')||feats.knowledge_graph?'active':'learning',
    conversation_memory:memr?.stats?.total_messages>0?'active':memr?'learning':'off',
    media_context:caps.includes('voice_context')||caps.includes('media')?'active':'learning',
    energy_context:er?.status==='ok'||er?.ok?'active':er?'learning':'off',
    weather_context:wr?.status==='ok'||wr?.ok?'active':wr?'learning':'off',
    unifi_context: ur?.status==='healthy'?'active':ur?.status==='degraded'?'learning':'off',
    camera_context:caps.includes('camera')||caps.includes('events')?'learning':'off',
    user_preferences:caps.includes('user_preferences')||feats.multi_user_learning?'active':'learning',
    telegram_bot:  tgr?.running?'active':'off',
    mcp_server:    capr?.ok?'active':'off',
    _details:{
      brain_graph: gr?.ok?`${gr?.stats?.nodes||gr?.nodes_total||0} Nodes, ${gr?.stats?.edges||gr?.edges_total||0} Edges`:'API offline',
      habitus_miner:hr?.status==='ok'?`${hr?.rules_count||0} Regeln`:(hr?'Kein Output':'API offline'),
      mood_engine:  mr?.zones?`${Object.keys(mr.zones).length} Zonen`:(mr?'Keine Zonen':'API offline'),
      neurons:      neurons.length>0?`${neurons.length} Signale aktiv`:'Warte auf Events',
      conversation_memory:memr?.stats?`${memr.stats.total_messages||0} Nachrichten`:'Leer',
      energy_context:er?.status==='ok'?'Online':(er?'Degradiert':'Nicht konfiguriert'),
      weather_context:wr?.status==='ok'?'Online':(wr?'Degradiert':'Nicht konfiguriert'),
      unifi_context:ur?.status||'Nicht konfiguriert',
      telegram_bot:tgr?.running?'Polling aktiv':'Nicht konfiguriert',
      mcp_server:capr?.ok?'Aktiv':'Nicht erreichbar',
    }
  };
  _healthTs=Date.now();
  return _moduleHealth;
}
function addHistory(text){
  const now=new Date();const t=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  historyLog.unshift({time:t,text});
  renderHistory();
}
function renderHistory(){
  const c=$('history-items');if(!c)return;
  c.innerHTML=historyLog.slice(0,30).map(h=>`<div class="hist-item"><span class="ht">${h.time}</span><span>${h.text}</span></div>`).join('');
}

// -- Navigation --
document.querySelectorAll('.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');$('page-'+btn.dataset.page).classList.add('active');
    loadPage(btn.dataset.page);
  });
});
function navigateTo(p){
  document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active',b.dataset.page===p));
  document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
  $('page-'+p).classList.add('active');loadPage(p);
}

// ==================================================
// STYX PAGE (Brain + Chat + History)
// ==================================================
async function loadStyx(){
  try{
    // Load status
    const status=await api('/chat/status');
    const dot=$('status-dot'),txt=$('status-text');
    if(status){
      if(status.available){dot.className='dot dot-green';txt.textContent='Online'}
      else{dot.className='dot dot-yellow';txt.textContent='Bereit'}
      currentModel=status.model||'';
      $('chat-model').textContent=escapeHtml(currentModel)||'--';
      $('ver-badge').textContent='v'+(status.version||'1.2.0');
      const name=status.assistant_name||'Styx';
      $('assistant-name').textContent=escapeHtml(name);
      $('app-title').textContent=escapeHtml(name)+' \u2014 PilotSuite';
      document.title='PilotSuite \u2014 '+escapeHtml(name);
    }else{
      dot.className='dot dot-red';txt.textContent='API offline';
      addHistory('\u26a0\ufe0f Core API nicht erreichbar');
    }
    // Load pipelines (real health)
    loadPipelines();
    // Load brain
    loadBrainGraph();
    // Load suggestion inbox
    loadSuggestionInbox();
    addHistory('Dashboard geladen');
  }catch(e){
    console.error('loadStyx error:',e);
    const dot=$('status-dot'),txt=$('status-text');
    if(dot)dot.className='dot dot-red';
    if(txt)txt.textContent='Fehler';
  }
}

async function loadPipelines(){
  const c=$('pipelines');if(!c)return;
  c.innerHTML='<div style="font-size:10px;color:var(--dim);padding:5px 0">Module pruefen...</div>';
  try{
    const health=await fetchModuleHealth();
    c.innerHTML='';
    MODULE_DEFS.forEach(m=>{
      // User override from localStorage takes priority over detected health
      const detected=health[m.id]||'unknown';
      const userSt=moduleStates[m.id];
      const st=userSt||detected;
      if(!moduleStates[m.id])moduleStates[m.id]=detected;
      const detail=health._details?.[m.id]||'';
      const d=el('div','pipe pipe-'+st,`<span class="pd"></span><span>${escapeHtml(m.name)}</span>`);
      if(detail)d.title=detail;
      d.onclick=()=>navigateTo('modules');
      c.appendChild(d);
    });
  }catch(e){
    c.innerHTML='<div style="font-size:10px;color:var(--red);padding:5px 0">\u26a0\ufe0f Modul-Status nicht ladbar</div>';
  }
}

// -- Brain Graph --
let brainNodes=[],brainEdges=[];
async function loadBrainGraph(){
  const data=await api('/api/v1/graph/state?limitNodes=120&limitEdges=300');
  const c=$('brain-canvas');
  if(!data||!data.nodes||!data.nodes.length){
    const inner=c.querySelector('.loading');
    if(inner)inner.innerHTML='<div class="empty">Brain Graph ist noch leer.<br>Events von HA werden automatisch verarbeitet.</div>';
    return;
  }
  brainNodes=data.nodes;brainEdges=data.edges||[];
  addHistory(brainNodes.length+' Brain-Nodes geladen');
  renderBrain(c,brainNodes,brainEdges);
  renderLegend();
}
function reloadBrain(){loadBrainGraph()}

function renderBrain(container,nodes,edges){
  const rect=container.getBoundingClientRect();
  const W=rect.width||800,H=rect.height||500;
  const nodeMap={};
  nodes.forEach(n=>{
    n.x=W/2+(Math.random()-.5)*W*.7;n.y=H/2+(Math.random()-.5)*H*.7;n.vx=0;n.vy=0;
    nodeMap[n.id||n.entity_id]=n;
  });
  // Force simulation
  for(let iter=0;iter<120;iter++){
    for(let i=0;i<nodes.length;i++){
      for(let j=i+1;j<nodes.length;j++){
        let dx=nodes[j].x-nodes[i].x,dy=nodes[j].y-nodes[i].y;
        let d=Math.sqrt(dx*dx+dy*dy)||1;
        let f=1000/(d*d);
        nodes[i].vx-=dx/d*f;nodes[i].vy-=dy/d*f;
        nodes[j].vx+=dx/d*f;nodes[j].vy+=dy/d*f;
      }
    }
    edges.forEach(e=>{
      const s=nodeMap[e.source||e.from],t=nodeMap[e.target||e.to];
      if(!s||!t)return;
      let dx=t.x-s.x,dy=t.y-s.y,d=Math.sqrt(dx*dx+dy*dy)||1;
      let f=(d-90)*.008;
      s.vx+=dx/d*f;s.vy+=dy/d*f;t.vx-=dx/d*f;t.vy-=dy/d*f;
    });
    nodes.forEach(n=>{
      n.vx+=(W/2-n.x)*.0008;n.vy+=(H/2-n.y)*.0008;
      n.vx*=.82;n.vy*=.82;
      n.x+=n.vx;n.y+=n.vy;
      n.x=Math.max(25,Math.min(W-25,n.x));n.y=Math.max(25,Math.min(H-25,n.y));
    });
  }
  // SVG
  let svg=`<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
  svg+=`<defs><filter id="glow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>`;
  // Edges
  edges.forEach(e=>{
    const s=nodeMap[e.source||e.from],t=nodeMap[e.target||e.to];
    if(!s||!t)return;
    const w=Math.max(.3,Math.min(2.5,(e.weight||.5)*3));
    svg+=`<line x1="${s.x}" y1="${s.y}" x2="${t.x}" y2="${t.y}" stroke="#1e2a3a" stroke-width="${w}" stroke-opacity=".4"/>`;
  });
  // Nodes
  nodes.forEach(n=>{
    const domain=(n.id||n.entity_id||'').split('.')[0];
    const color=DOMAIN_COLORS[domain]||DOMAIN_COLORS.default;
    const r=4+Math.min(10,(n.score||.5)*7);
    const label=escapeHtml((n.id||n.entity_id||'').split('.').pop().replace(/_/g,' ').slice(0,18));
    svg+=`<circle cx="${n.x}" cy="${n.y}" r="${r}" fill="${color}" opacity=".8" filter="url(#glow)"/>`;
    if(r>6)svg+=`<text x="${n.x}" y="${n.y+r+10}" text-anchor="middle" fill="#6b7a8d" font-size="7.5" font-family="Inter,sans-serif">${label}</text>`;
  });
  svg+='</svg>';
  // Keep legend and controls
  const legend=container.querySelector('.brain-legend');
  const controls=container.querySelector('.brain-controls');
  container.innerHTML=svg;
  if(legend)container.appendChild(legend);
  if(controls)container.appendChild(controls);
}

function renderLegend(){
  const c=$('brain-legend');if(!c)return;
  const domains={};
  brainNodes.forEach(n=>{const d=(n.id||n.entity_id||'').split('.')[0];domains[d]=(domains[d]||0)+1});
  c.innerHTML='';
  Object.entries(domains).sort((a,b)=>b[1]-a[1]).slice(0,8).forEach(([d,cnt])=>{
    const color=DOMAIN_COLORS[d]||DOMAIN_COLORS.default;
    c.innerHTML+=`<div class="leg"><span class="dot-lg" style="background:${color}"></span>${d} (${cnt})</div>`;
  });
}

// -- Chat --
const chatInput=$('chat-input');
chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat()}});

async function sendChat(){
  const input=$('chat-input'),msg=input.value.trim();
  if(!msg)return;
  input.value='';
  const msgs=$('chat-msgs');
  msgs.appendChild(el('div','msg u',msg));msgs.scrollTop=msgs.scrollHeight;
  chatHistory.push({role:'user',content:msg});
  addHistory('Chat: '+msg.slice(0,40)+(msg.length>40?'...':''));
  const btn=$('chat-send');btn.disabled=true;
  const typing=el('div','msg a','<div class="spinner" style="display:inline-block;width:12px;height:12px;margin-right:6px"></div>Denkt nach...');
  msgs.appendChild(typing);msgs.scrollTop=msgs.scrollHeight;
  try{
    const r=await fetch(API+'/v1/chat/completions',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:currentModel,messages:chatHistory.slice(-10),stream:false})
    });
    const data=await r.json();
    const reply=data?.choices?.[0]?.message?.content||data?.error?.message||'Keine Antwort.';
    // XSS-safe: escape first, then convert newlines to <br>
    typing.innerHTML=escapeHtml(reply).replace(/\n/g,'<br>');
    chatHistory.push({role:'assistant',content:reply});
    addHistory('Styx: '+reply.slice(0,40)+(reply.length>40?'...':''));
  }catch(e){typing.textContent='Fehler: '+e.message}
  btn.disabled=false;msgs.scrollTop=msgs.scrollHeight;
}

// -- Suggestion Inbox --
let suggestionItems=[];
let dismissedSuggestions=JSON.parse(localStorage.getItem('styx_dismissed_sugg')||'[]');

async function loadSuggestionInbox(){
  const list=$('sugg-list');
  if(!list)return;
  // Resilient: allSettled means one failing API doesn't block others
  const settled=await Promise.allSettled([
    api('/api/v1/habitus/rules?limit=15'),
    api('/api/v1/candidates/graph_candidates?limit=10'),
    api('/api/v1/hints?status=pending')
  ]);
  const [rulesRes,candidatesRes,hintsRes]=settled.map(r=>r.status==='fulfilled'?r.value:null);
  const rulesData=rulesRes,candidatesData=candidatesRes,hintsData=hintsRes;
  suggestionItems=[];
  // 1. Pending hints (already in the system)
  const hints=hintsData?.hints||[];
  hints.forEach(h=>{
    if(dismissedSuggestions.includes(h.id))return;
    // Parse consequent from text if present (format: "X -> Y")
    let ant=h.text||h.title||'?',cons=h.consequent||h.then||'';
    if(!cons&&ant.includes(' -> ')){const parts=ant.split(' -> ');ant=parts[0];cons=parts.slice(1).join(' -> ')}
    suggestionItems.push({
      id:h.id,type:'hint',status:h.status||'pending',
      antecedent:ant,consequent:cons,
      confidence:h.confidence||0,zone:h.zone||'',
      source:'hints',raw:h
    });
  });
  // 2. Habitus rules as suggestions
  const rules=rulesData?.rules||rulesData?.data||[];
  rules.forEach(r=>{
    const m=r.metadata||r;
    const ant=m.antecedent?.full||m.antecedent||'?';
    const cons=m.consequent?.full||m.consequent||'?';
    const sid='rule_'+btoa(ant+'->'+cons).slice(0,16);
    if(dismissedSuggestions.includes(sid))return;
    suggestionItems.push({
      id:sid,type:'rule',status:'pending',
      antecedent:ant,consequent:cons,
      confidence:m.confidence||0,lift:m.lift||0,support:m.support||0,
      zone:m.zone||'',source:'habitus',raw:m
    });
  });
  // 3. Graph candidates (Brain Graph edges)
  const candidates=candidatesData?.items||[];
  candidates.forEach(c=>{
    if(dismissedSuggestions.includes(c.candidate_id))return;
    const d=c.data||{};
    const fromId=(d.from||'').replace('ha.entity:','');
    const toId=(d.to||'').replace('ha.entity:','');
    suggestionItems.push({
      id:c.candidate_id,type:'graph',status:'pending',
      antecedent:fromId||c.title||'?',consequent:toId||'',
      confidence:d.evidence?.weight||0,zone:'',
      edgeType:d.edge_type||'observed_with',
      source:'brain_graph',raw:c
    });
  });
  // Limit to 15, sort by confidence
  suggestionItems.sort((a,b)=>(b.confidence||0)-(a.confidence||0));
  suggestionItems=suggestionItems.slice(0,15);
  renderSuggestionInbox();
}

function renderSuggestionInbox(){
  const list=$('sugg-list');
  const countEl=$('sugg-count');
  const pending=suggestionItems.filter(s=>s.status==='pending');
  if(countEl)countEl.textContent=pending.length;
  if(!pending.length&&!suggestionItems.length){
    list.innerHTML='<div class="sugg-empty">Noch keine Vorschlaege. Styx lernt aus Events und erstellt automatisch Muster.</div>';
    return;
  }
  list.innerHTML='';
  suggestionItems.forEach((s,i)=>{
    if(s.status==='rejected')return;// hide rejected
    const item=document.createElement('div');
    item.className='sugg-item'+(s.status==='accepted'?' accepted':'');
    item.dataset.idx=i;
    // Source icon + color
    const srcIcon=s.source==='brain_graph'?'\u{1F9E0}':s.source==='habitus'?'\u{1F50D}':'\u{1F4A1}';
    const srcColor=s.source==='brain_graph'?'var(--accent)':s.source==='habitus'?'var(--cyan)':'var(--yellow)';
    // Zone tag (escaped)
    const zoneTag=s.zone?`<span class="zone-tag">${escapeHtml(s.zone)}</span>`:'';
    // Source tag
    const srcLabel=s.source==='brain_graph'?'Graph':s.source==='habitus'?'Habitus':'Hint';
    const srcTag=`<span class="zone-tag" style="background:${srcColor}15;color:${srcColor}">${srcLabel}</span>`;
    const confPct=s.type==='graph'?((s.confidence||0)*10).toFixed(0)+'w':((s.confidence||0)*100).toFixed(0)+'%';
    const antEsc=escapeHtml(s.antecedent);
    const consEsc=escapeHtml(s.consequent);
    item.innerHTML=`
      <input type="checkbox" class="sugg-check" data-idx="${i}" onchange="updateBatchBar()">
      <span style="font-size:14px;flex-shrink:0">${srcIcon}</span>
      <div class="sugg-body">
        <div class="sugg-rule"><span>${antEsc}</span>${consEsc?'<span class="arr">\u2192</span><span>'+consEsc+'</span>':''}</div>
        <div class="sugg-zone">${srcTag}${zoneTag}</div>
      </div>
      <span class="sugg-conf">${confPct}</span>
      <div class="sugg-actions">
        ${s.status==='pending'?`
          <button class="sugg-act accept" onclick="acceptSuggestion(${i})" title="Annehmen">\u2713</button>
          <button class="sugg-act reject" onclick="rejectSuggestion(${i})" title="Ablehnen">\u2717</button>
        `:`<span class="b b-g" style="font-size:9px">\u2713</span>`}
      </div>`;
    list.appendChild(item);
  });
}

function updateBatchBar(){
  const checked=document.querySelectorAll('.sugg-check:checked');
  const bar=$('sugg-batch');
  if(bar)bar.style.display=checked.length>0?'flex':'none';
}

async function acceptSuggestion(idx){
  const s=suggestionItems[idx];if(!s||s.status!=='pending')return;
  s.status='accepted';
  addHistory('Vorschlag angenommen: '+s.antecedent+(s.consequent?' \u2192 '+s.consequent:''));
  // 1. Create hint in backend
  try{
    const hintRes=await fetch(API+'/api/v1/hints',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text:s.antecedent+(s.consequent?' -> '+s.consequent:''),type:'automation'})
    });
    const hintData=await hintRes.json();
    const hintId=hintData?.hint?.id||s.id;
    // 2. Accept the hint
    await fetch(API+'/api/v1/hints/'+hintId+'/accept',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});
  }catch(e){console.warn('Hint accept error:',e)}
  // 3. Touch edge in Brain Graph (visual connection)
  if(s.consequent&&s.antecedent){
    const fromNode=s.raw?.data?.from||'ha.entity:'+s.antecedent;
    const toNode=s.raw?.data?.to||'ha.entity:'+s.consequent;
    try{
      await fetch(API+'/api/v1/graph/ops',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({op:'touch_edge',from:fromNode,to:toNode,type:s.edgeType||'controls',delta:1.0})
      });
    }catch(e){console.warn('Graph ops error:',e)}
    // 4. Animate edge in Brain SVG
    animateBrainEdge(s.antecedent,s.consequent);
  }
  renderSuggestionInbox();
}

async function rejectSuggestion(idx){
  const s=suggestionItems[idx];if(!s||s.status!=='pending')return;
  s.status='rejected';
  dismissedSuggestions.push(s.id);
  // Keep only last 100 dismissed
  if(dismissedSuggestions.length>100)dismissedSuggestions=dismissedSuggestions.slice(-100);
  localStorage.setItem('styx_dismissed_sugg',JSON.stringify(dismissedSuggestions));
  addHistory('Vorschlag abgelehnt: '+s.antecedent);
  // Backend reject if it's a hint
  if(s.type==='hint'){
    try{await fetch(API+'/api/v1/hints/'+s.id+'/reject',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'})}catch(e){}
  }
  renderSuggestionInbox();
}

async function batchAccept(){
  const checked=document.querySelectorAll('.sugg-check:checked');
  const indices=[...checked].map(c=>parseInt(c.dataset.idx));
  for(const idx of indices)await acceptSuggestion(idx);
  updateBatchBar();
  addHistory(indices.length+' Vorschlaege angenommen (Batch)');
}

async function batchReject(){
  const checked=document.querySelectorAll('.sugg-check:checked');
  const indices=[...checked].map(c=>parseInt(c.dataset.idx));
  for(const idx of indices)await rejectSuggestion(idx);
  updateBatchBar();
  addHistory(indices.length+' Vorschlaege abgelehnt (Batch)');
}

function animateBrainEdge(fromEntity,toEntity){
  const svg=document.querySelector('#brain-canvas svg');
  if(!svg||!brainNodes.length)return;
  // Find matching nodes
  const fromNode=brainNodes.find(n=>{const id=n.id||n.entity_id||'';return id.includes(fromEntity)});
  const toNode=brainNodes.find(n=>{const id=n.id||n.entity_id||'';return id.includes(toEntity)});
  if(!fromNode||!toNode)return;
  // Create animated edge
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  line.setAttribute('x1',fromNode.x);line.setAttribute('y1',fromNode.y);
  line.setAttribute('x2',toNode.x);line.setAttribute('y2',toNode.y);
  line.setAttribute('class','brain-edge-new');
  line.setAttribute('stroke','#34d399');line.setAttribute('stroke-width','3');
  svg.appendChild(line);
  // Pulse circles at endpoints
  [fromNode,toNode].forEach(n=>{
    const circ=document.createElementNS('http://www.w3.org/2000/svg','circle');
    circ.setAttribute('cx',n.x);circ.setAttribute('cy',n.y);circ.setAttribute('r','8');
    circ.setAttribute('fill','none');circ.setAttribute('stroke','#34d399');circ.setAttribute('stroke-width','2');
    circ.setAttribute('opacity','1');
    svg.appendChild(circ);
    // Animate expand + fade
    let frame=0;
    const anim=()=>{frame++;const r=8+frame*.5;const op=Math.max(0,1-frame/30);
      circ.setAttribute('r',r);circ.setAttribute('opacity',op);
      if(frame<30)requestAnimationFrame(anim);else circ.remove();
    };requestAnimationFrame(anim);
  });
  // Remove animated line after 3s (it stays as a regular edge)
  setTimeout(()=>{line.classList.remove('brain-edge-new');line.setAttribute('stroke','#34d399');line.setAttribute('stroke-opacity','.6');line.setAttribute('stroke-width','1.5')},3000);
}

// ==================================================
// HABITUS
// ==================================================
async function loadHabitus(){
  const data=await api('/api/v1/habitus/rules?limit=50');
  const rules=data?.rules||data?.data||[];
  $('hab-count').textContent=rules.length+' Regeln';
  const c=$('hab-rules');
  if(!rules.length){c.innerHTML='<div class="empty">Noch keine Muster. PilotSuite lernt automatisch aus Events.</div>';return}
  c.innerHTML='';
  rules.forEach(r=>{
    const m=r.metadata||r;
    const ant=escapeHtml(m.antecedent?.full||m.antecedent||'?');
    const cons=escapeHtml(m.consequent?.full||m.consequent||'?');
    const conf=((m.confidence||0)*100).toFixed(0);
    const supp=((m.support||0)*100).toFixed(1);
    const lift=(m.lift||0).toFixed(2);
    c.appendChild(el('div','pat',
      `<span>${ant}</span><span class="arr">\u2192</span><span>${cons}</span><span class="meta">${conf}% | ${supp}% Supp | Lift ${lift}</span>`));
  });
  // Zones
  const zones=await api('/api/v1/habitus/config');
  const zc=$('hab-zones');
  if(zones&&zones.zones){
    zc.innerHTML='';
    Object.entries(zones.zones).forEach(([id,z])=>{
      const card=el('div','zone-card',
        `<h3><span style="color:var(--cyan)">&#x1f3e0;</span> ${escapeHtml(z.name||id)}</h3>
        <p style="font-size:11px;color:var(--dim)">${escapeHtml(z.description||'Zone: '+id)}</p>
        <div class="zone-entities">${(z.entities||[]).map(e=>`<span class="ze">${escapeHtml(e)}</span>`).join('')}</div>`);
      zc.appendChild(card);
    });
  }else{
    zc.innerHTML='<div class="empty">Keine Zonen konfiguriert. Zonen werden in HA Options definiert.</div>';
  }
  // Trend from real rule confidence values
  const trendData=rules.map(r=>(r.metadata||r).confidence||0);
  drawTrend('hab-trend-canvas',rules.length,trendData.length>=2?trendData:null);
}

// -- Add Habitus Zone --
async function addZone(){
  const name=$('new-zone-name').value.trim();
  const ents=$('new-zone-entities').value.trim();
  if(!name){$('new-zone-name').style.borderColor='var(--red)';return}
  const entities=ents?ents.split(',').map(e=>e.trim()).filter(Boolean):[];
  try{
    const r=await fetch(API+'/api/v1/habitus/config',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({zones:{[name.toLowerCase().replace(/\s+/g,'_')]:{name,entities,description:'Zone: '+name}}})
    });
    if(r.ok){
      $('new-zone-name').value='';$('new-zone-entities').value='';
      addHistory('Zone erstellt: '+name);
      loadHabitus();
    }else{addHistory('Zone-Fehler: '+r.status)}
  }catch(e){addHistory('Zone-Fehler: '+e.message)}
}

// ==================================================
// MOOD
// ==================================================
async function loadMood(){
  const data=await api('/api/v1/mood/state');
  const c=$('mood-zones'),sc=$('mood-stats');
  if(!data||!data.zones){c.innerHTML='<div class="empty">Noch keine Stimmungsdaten. Mood Engine benoetigt Events aus Zonen.</div>';return}
  c.innerHTML='';
  const zones=Object.entries(data.zones||{});
  if(!zones.length){c.innerHTML='<div class="empty">Keine Zonen konfiguriert.</div>';return}
  zones.forEach(([name,z])=>{
    const comfort=z.comfort||0,joy=z.joy||0,frug=z.frugality||0;
    c.appendChild(el('div','',
      `<h3 style="font-size:13px;margin:12px 0 6px;font-weight:600">${escapeHtml(name)}</h3>`+
      gaugeHTML('Comfort',comfort,'var(--green)')+gaugeHTML('Joy',joy,'var(--yellow)')+gaugeHTML('Frugality',frug,'var(--accent)')));
  });
  if(data.summary){
    sc.innerHTML=
      `<div class="card stat"><div class="v">${(data.summary.average_comfort||0).toFixed(1)}</div><div class="l">Avg Comfort</div></div>`+
      `<div class="card stat"><div class="v">${(data.summary.average_joy||0).toFixed(1)}</div><div class="l">Avg Joy</div></div>`+
      `<div class="card stat"><div class="v">${(data.summary.average_frugality||0).toFixed(1)}</div><div class="l">Avg Frugality</div></div>`;
  }
  // Mood trend from real comfort values per zone
  const moodTrend=zones.map(([_,z])=>z.comfort||0);
  drawTrend('mood-trend-canvas',zones.length*3,moodTrend.length>=2?moodTrend:null);
}
function gaugeHTML(label,val,color){
  const pct=Math.max(0,Math.min(100,val*100));
  return `<div class="gauge"><div class="gauge-hd"><span>${label}</span><span class="gv">${pct.toFixed(0)}%</span></div><div class="gauge-bar"><div class="gauge-fill" style="width:${pct}%;background:${color}"></div></div></div>`;
}

// ==================================================
// MODULES
// ==================================================
async function loadModules(){
  const c=$('module-list');if(!c)return;
  c.innerHTML='<div class="loading"><div class="spinner"></div>Lade Modul-Status...</div>';
  try{
    const health=await fetchModuleHealth();
    c.innerHTML='';
    MODULE_DEFS.forEach(m=>{
      // Detected state from APIs
      const detected=health[m.id]||'unknown';
      const detail=health._details?.[m.id]||'Status unbekannt';
      // User toggle override stored in localStorage
      const st=moduleStates[m.id]||detected;
      if(!moduleStates[m.id])moduleStates[m.id]=detected;
      const toggleCls=st==='active'?'on':st==='learning'?'learn':'off';
      const badgeCls=st==='active'?'g':st==='learning'?'y':st==='off'?'r':'b';
      const card=el('div','mod-card',
        `<div class="mod-icon" style="background:${m.color}20;color:${m.color}">${m.icon}</div>
        <div class="mod-info"><h3>${escapeHtml(m.name)}</h3><p>${escapeHtml(m.desc)}</p>
        <div style="margin-top:4px">${badge(detail,badgeCls)}</div></div>
        <div class="mod-status">
          <button class="mod-toggle ${toggleCls}" data-mod="${m.id}" title="${escapeHtml(st)}"></button>
          <span class="mod-st-label" style="font-size:9px;color:var(--dim)">${escapeHtml(st)}</span>
          ${detected!==st?`<span style="font-size:8px;color:var(--yellow)" title="Nutzer-Override aktiv">\u270f</span>`:''}
        </div>`);
      card.querySelector('.mod-toggle').addEventListener('click',function(){toggleModule(this,m.id)});
      c.appendChild(card);
    });
  }catch(e){
    c.innerHTML='<div class="empty">\u26a0\ufe0f Modul-Status konnte nicht geladen werden.<br>'+escapeHtml(e.message)+'</div>';
  }
}

// -- Module Toggle (persists to localStorage, syncs pipeline) --
function toggleModule(btn,modId){
  const states=['on','learn','off'];
  const labels=['active','learning','off'];
  const current=[...btn.classList].find(c=>states.includes(c))||'off';
  let idx=states.indexOf(current);
  idx=(idx+1)%3;
  btn.className='mod-toggle '+states[idx];
  btn.title=labels[idx];
  const stLabel=btn.parentElement.querySelector('.mod-st-label');
  if(stLabel)stLabel.textContent=labels[idx];
  // Show override indicator
  const oi=btn.parentElement.querySelector('.override-indicator');
  if(oi)oi.style.display='';
  moduleStates[modId]=labels[idx];
  // Persist to localStorage
  localStorage.setItem('styx_module_states',JSON.stringify(moduleStates));
  // Invalidate health cache so next load re-evaluates
  _moduleHealth=null;_healthTs=0;
  // Update pipeline indicator on Styx page
  const pipes=document.querySelectorAll('#pipelines .pipe');
  pipes.forEach(p=>{
    const span=p.querySelector('span:last-child');
    const def=MODULE_DEFS.find(m=>m.name===span?.textContent);
    if(def&&def.id===modId)p.className='pipe pipe-'+labels[idx];
  });
  addHistory('Modul '+escapeHtml(MODULE_DEFS.find(m=>m.id===modId)?.name||modId)+' \u2192 '+labels[idx]);
}

// ==================================================
// SETTINGS
// ==================================================
async function loadSettings(){
  // Load all in parallel, resilient
  const settled=await Promise.allSettled([
    api('/chat/status'),
    api('/telegram/status'),
    api('/chat/memory'),
    api('/chat/models/recommended'),
    api('/api/v1/capabilities'),
  ]);
  const [statusRes,tgRes,memRes,recRes,capsRes]=settled.map(r=>r.status==='fulfilled'?r.value:null);
  const status=statusRes,tg=tgRes,mem=memRes,rec=recRes,caps=capsRes;
  if(status){
    $('set-llm').innerHTML=
      `<tr><td>Provider</td><td>${badge(status.active_provider||'--','p')}</td></tr>`+
      `<tr><td>Modell</td><td><strong>${escapeHtml(status.model||'--')}</strong></td></tr>`+
      `<tr><td>Assistent</td><td><strong>${escapeHtml(status.assistant_name||'Styx')}</strong></td></tr>`+
      `<tr><td>Ollama</td><td>${status.ollama_available?badge('Online','g'):badge('Offline','r')}</td></tr>`+
      `<tr><td>Cloud API</td><td>${status.cloud_configured?badge('Konfiguriert','b'):badge('Nicht konfiguriert','y')}</td></tr>`+
      `<tr><td>Lokal bevorzugen</td><td>${status.prefer_local?badge('Ja','g'):badge('Nein','y')}</td></tr>`+
      `<tr><td>Charakter</td><td>${escapeHtml(status.character||'copilot')}</td></tr>`+
      `<tr><td>Anfragen/h</td><td>${status.calls_this_hour||0} / ${status.max_calls_per_hour||60}</td></tr>`;
    // Models
    const models=status.installed_models||[];
    const mc=$('set-models');
    if(!models.length){mc.innerHTML='<div class="empty">Keine Modelle installiert</div>'}
    else{mc.innerHTML='';models.forEach(m=>{mc.appendChild(el('div','pat',`<span>${escapeHtml(m)}</span><span class="meta">${m===status.model?badge('Aktiv','g'):''}</span>`))})}
    // System (real MCP status from capabilities)
    const mcpOk=caps?.ok===true;
    $('set-system').innerHTML=
      `<tr><td>Version</td><td>${badge('v'+(status.version||'1.2.0'),'p')}</td></tr>`+
      `<tr><td>Ollama URL</td><td><code>${escapeHtml(status.ollama_url||'localhost:11434')}</code></td></tr>`+
      `<tr><td>Cloud URL</td><td><code>${escapeHtml(status.cloud_api_url||'--')}</code></td></tr>`+
      `<tr><td>Telegram</td><td>${tg?.running?badge('Aktiv','g'):badge('Aus','y')}</td></tr>`+
      `<tr><td>MCP Server</td><td>${mcpOk?badge('Aktiv','g'):badge('Offline','r')}</td></tr>`+
      (caps?.capabilities?.length?`<tr><td>Features</td><td style="font-size:10px;color:var(--dim)">${escapeHtml(caps.capabilities.slice(0,5).join(', '))}${caps.capabilities.length>5?'…':''}</td></tr>`:'');
  }else{
    $('set-llm').innerHTML='<tr><td colspan="2" style="color:var(--red)">\u26a0\ufe0f Core API nicht erreichbar</td></tr>';
  }
  // Memory
  const mc2=$('set-memory');
  if(mem&&mem.stats){
    mc2.innerHTML=`<table class="tbl">
      <tr><td>Nachrichten</td><td><strong>${mem.stats.total_messages||0}</strong></td></tr>
      <tr><td>Praeferenzen</td><td><strong>${(mem.preferences||[]).length}</strong></td></tr>
      <tr><td>Themen</td><td><strong>${mem.stats.topics_count||0}</strong></td></tr>
      <tr><td>Speicher</td><td>${mem.stats.db_size_mb?mem.stats.db_size_mb.toFixed(1)+' MB':'--'}</td></tr>
    </table>`;
  }else{mc2.innerHTML='<div class="empty">Gedaechtnis nicht initialisiert oder API offline</div>'}
  // Recommended
  const rc=$('set-rec');
  if(rec&&rec.models){
    rc.innerHTML='';
    rec.models.forEach(m=>{
      const mbadges=[m.installed?badge('Installiert','g'):badge((m.size_mb||'?')+'MB','y')];
      if(m.active)mbadges.push(badge('Aktiv','p'));
      if(m.supports_tools)mbadges.push(badge('Tools','b'));
      rc.appendChild(el('div','pat',
        `<div><strong>${escapeHtml(m.name||'')}</strong><br><span style="font-size:10px;color:var(--dim)">${escapeHtml(m.description||'')}</span></div>
        <div class="meta">${mbadges.join(' ')}</div>`));
    });
  }else{rc.innerHTML='<div class="empty">Keine Empfehlungen verfuegbar</div>'}
}

// ==================================================
// TREND CHART (mini canvas)
// ==================================================
function drawTrend(canvasId,dataPoints,realData){
  const canvas=$(canvasId);if(!canvas||!canvas.getContext)return;
  const ctx=canvas.getContext('2d');
  const W=Math.max(canvas.parentElement.clientWidth||200,100);const H=120;
  canvas.width=W;canvas.height=H;
  ctx.clearRect(0,0,W,H);
  if(!realData||realData.length<2){
    // No fake data — show honest "insufficient data" message
    ctx.fillStyle='#1e2a3a';ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='#1e2a3a';ctx.lineWidth=.5;
    for(let y=0;y<H;y+=30){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
    ctx.fillStyle='#6b7a8d';ctx.font='11px Inter,sans-serif';ctx.textAlign='center';
    ctx.fillText('Noch nicht genug Daten',W/2,H/2-8);
    ctx.font='9px Inter,sans-serif';
    ctx.fillText('Styx sammelt automatisch Verlaufsdaten',W/2,H/2+8);
    ctx.textAlign='left';
    return;
  }
  const pts=Math.min(realData.length,48);
  const data=[];
  for(let i=0;i<pts;i++){
    const idx=Math.floor(i*realData.length/pts);
    data.push(Math.max(0,Math.min(1,realData[idx])));
  }
  // Grid
  ctx.strokeStyle='#1e2a3a';ctx.lineWidth=.5;
  for(let y=0;y<H;y+=30){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
  // Line
  const grad=ctx.createLinearGradient(0,0,W,0);
  grad.addColorStop(0,'#7c6aef');grad.addColorStop(.5,'#22d3ee');grad.addColorStop(1,'#34d399');
  ctx.strokeStyle=grad;ctx.lineWidth=2;ctx.beginPath();
  data.forEach((v,i)=>{
    const x=(i/(pts-1))*W;const y=H-v*H*.8-H*.1;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();
  // Fill area
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();
  const fillGrad=ctx.createLinearGradient(0,0,0,H);
  fillGrad.addColorStop(0,'rgba(124,106,239,.15)');fillGrad.addColorStop(1,'rgba(124,106,239,0)');
  ctx.fillStyle=fillGrad;ctx.fill();
  // Labels
  ctx.fillStyle='#6b7a8d';ctx.font='9px Inter,sans-serif';
  ctx.fillText(pts+'pts',4,H-4);ctx.fillText('jetzt',W-28,H-4);
}

// ==================================================
// PAGE LOADER — Resilient wrapper
// ==================================================
const _loaders={styx:loadStyx,habitus:loadHabitus,mood:loadMood,modules:loadModules,settings:loadSettings};
function loadPage(p){
  const fn=_loaders[p];
  if(!fn)return;
  fn().catch(e=>{
    console.error('Page load error ['+p+']:',e);
    const pg=$('page-'+p);
    if(pg&&!pg.querySelector('.page-error')){
      const err=el('div','card page-error',
        `<p style="color:var(--red)">\u26a0\ufe0f Fehler beim Laden: ${escapeHtml(e.message)}</p>
         <button onclick="loadPage('${escapeHtml(p)}')" style="margin-top:8px;padding:6px 14px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer">Erneut versuchen</button>`);
      err.style.margin='16px';
      pg.insertBefore(err,pg.firstChild);
    }
  });
}

// Boot — resilient startup
loadStyx().catch(e=>console.error('Boot error:',e));
// Auto-refresh Styx every 30s
setInterval(()=>{
  try{
    if(document.querySelector('.nav button.active')?.dataset.page==='styx')loadStyx().catch(()=>{});
  }catch(e){}
},30000);
</script>
</body>
</html>
