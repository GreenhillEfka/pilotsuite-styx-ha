openapi: 3.0.3
info:
  title: AI Home CoPilot HA Integration Services
  description: |
    Home Assistant Services for AI Home CoPilot Integration.
    
    These services are called via `hass.services.async_call()` or from HA automations/scripts.
    
    ## Service Categories
    - **Tag Registry**: Entity tagging and classification
    - **Media Context v2**: Zone-based media context
    - **N3 Forwarder**: Event forwarding to Core
    - **Ops Runbook**: Operational checks and actions
    - **Habitus Dashboard**: Pattern dashboard cards
    - **MUPL**: Multi-User Preference Learning
    
    ## Usage
    Services are called via Home Assistant service calls:
    
    ```yaml
    service: ai_home_copilot.tag_registry_upsert_tag
    data:
      tag_key: "aicp.place.kueche"
      title: "KÃ¼che"
      icon: "mdi:stove"
    ```
  version: 0.8.1
  contact:
    name: AI Home CoPilot
    url: https://github.com/GreenhillEfka/ai-home-copilot-ha
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: homeassistant://services
    description: Home Assistant Services

tags:
  - name: Tag Registry
    description: Entity tagging and classification (v0.2)
  - name: Media Context v2
    description: Zone-based media context management
  - name: N3 Forwarder
    description: Event forwarding to Core Add-on
  - name: Ops Runbook
    description: Operational checks and actions
  - name: Habitus Dashboard
    description: Pattern dashboard cards
  - name: MUPL
    description: Multi-User Preference Learning

paths:
  # ==================== TAG REGISTRY ====================
  /ai_home_copilot.tag_registry_upsert_tag:
    post:
      tags: [Tag Registry]
      summary: Create or update a tag
      operationId: upsertTag
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertTagRequest'
      responses:
        '200':
          description: Tag upserted successfully

  /ai_home_copilot.tag_registry_set_assignment:
    post:
      tags: [Tag Registry]
      summary: Assign tags to an entity
      operationId: setTagAssignment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetAssignmentRequest'
      responses:
        '200':
          description: Assignment set successfully

  /ai_home_copilot.tag_registry_confirm:
    post:
      tags: [Tag Registry]
      summary: Confirm a tag
      operationId: confirmTag
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmTagRequest'
      responses:
        '200':
          description: Tag confirmed

  /ai_home_copilot.tag_registry_sync_labels_now:
    post:
      tags: [Tag Registry]
      summary: Sync tags with HA labels immediately
      operationId: syncLabelsNow
      responses:
        '200':
          description: Sync initiated

  /ai_home_copilot.tag_registry_pull_from_core:
    post:
      tags: [Tag Registry]
      summary: Pull tag snapshot from Core Add-on
      operationId: pullFromCore
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PullFromCoreRequest'
      responses:
        '200':
          description: Snapshot pulled successfully

  # ==================== MEDIA CONTEXT V2 ====================
  /ai_home_copilot.media_context_v2_suggest_zone_mapping:
    post:
      tags: [Media Context v2]
      summary: Get zone mapping suggestions
      operationId: suggestZoneMapping
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EntryIdRequest'
      responses:
        '200':
          description: Suggestions fired as event

  /ai_home_copilot.media_context_v2_apply_zone_suggestions:
    post:
      tags: [Media Context v2]
      summary: Apply zone mapping suggestions
      operationId: applyZoneSuggestions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EntryIdRequest'
      responses:
        '200':
          description: Suggestions applied

  /ai_home_copilot.media_context_v2_clear_overrides:
    post:
      tags: [Media Context v2]
      summary: Clear manual overrides
      operationId: clearOverrides
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EntryIdRequest'
      responses:
        '200':
          description: Overrides cleared

  # ==================== N3 FORWARDER ====================
  /ai_home_copilot.forwarder_n3_start:
    post:
      tags: [N3 Forwarder]
      summary: Start N3 event forwarder
      operationId: startForwarder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EntryIdRequest'
      responses:
        '200':
          description: Forwarder started

  /ai_home_copilot.forwarder_n3_stop:
    post:
      tags: [N3 Forwarder]
      summary: Stop N3 event forwarder
      operationId: stopForwarder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EntryIdRequest'
      responses:
        '200':
          description: Forwarder stopped

  /ai_home_copilot.forwarder_n3_stats:
    post:
      tags: [N3 Forwarder]
      summary: Get forwarder statistics
      operationId: getForwarderStats
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EntryIdRequest'
      responses:
        '200':
          description: Stats fired as event

  # ==================== OPS RUNBOOK ====================
  /ai_home_copilot.ops_runbook_preflight_check:
    post:
      tags: [Ops Runbook]
      summary: Run preflight checks
      operationId: runPreflightCheck
      responses:
        '200':
          description: Preflight check completed

  /ai_home_copilot.ops_runbook_smoke_test:
    post:
      tags: [Ops Runbook]
      summary: Run smoke tests
      operationId: runSmokeTest
      responses:
        '200':
          description: Smoke test completed

  /ai_home_copilot.ops_runbook_execute_action:
    post:
      tags: [Ops Runbook]
      summary: Execute a runbook action
      operationId: executeRunbookAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteActionRequest'
      responses:
        '200':
          description: Action executed

  /ai_home_copilot.ops_runbook_run_checklist:
    post:
      tags: [Ops Runbook]
      summary: Run a checklist
      operationId: runChecklist
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunChecklistRequest'
      responses:
        '200':
          description: Checklist completed

  # ==================== HABITUS DASHBOARD ====================
  /ai_home_copilot.get_dashboard_patterns:
    get:
      tags: [Habitus Dashboard]
      summary: Get dashboard patterns
      operationId: getDashboardPatterns
      responses:
        '200':
          description: Patterns retrieved

  # ==================== MUPL ====================
  /ai_home_copilot.mupl_learn_preference:
    post:
      tags: [MUPL]
      summary: Learn a user preference
      operationId: learnPreference
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LearnPreferenceRequest'
      responses:
        '200':
          description: Preference learned

  /ai_home_copilot.mupl_set_user_priority:
    post:
      tags: [MUPL]
      summary: Set user priority
      operationId: setUserPriority
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetUserPriorityRequest'
      responses:
        '200':
          description: Priority set

  /ai_home_copilot.mupl_delete_user_data:
    post:
      tags: [MUPL]
      summary: Delete all user data
      operationId: deleteUserData
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserIdRequest'
      responses:
        '200':
          description: User data deleted

  /ai_home_copilot.mupl_export_user_data:
    post:
      tags: [MUPL]
      summary: Export user data
      operationId: exportUserData
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserIdRequest'
      responses:
        '200':
          description: Data exported (fired as event)

  /ai_home_copilot.mupl_detect_active_users:
    post:
      tags: [MUPL]
      summary: Detect currently active users
      operationId: detectActiveUsers
      responses:
        '200':
          description: Active users detected (fired as event)

  /ai_home_copilot.mupl_get_aggregated_mood:
    post:
      tags: [MUPL]
      summary: Get aggregated mood for users
      operationId: getAggregatedMood
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAggregatedMoodRequest'
      responses:
        '200':
          description: Aggregated mood (fired as event)

components:
  schemas:
    # ---------- COMMON ----------
    EntryIdRequest:
      type: object
      required:
        - entry_id
      properties:
        entry_id:
          type: string
          description: Config entry ID

    UserIdRequest:
      type: object
      required:
        - user_id
      properties:
        user_id:
          type: string
          description: Home Assistant user ID

    # ---------- TAG REGISTRY ----------
    UpsertTagRequest:
      type: object
      required:
        - tag_key
      properties:
        tag_key:
          type: string
          pattern: '^[a-z0-9_]+\.[a-z0-9_]+\.[a-z0-9_]+$'
          example: 'aicp.place.kueche'
          description: Tag key in namespace.facet.key format
        title:
          type: string
          description: Human-readable title
        icon:
          type: string
          description: Material Design icon name
          example: 'mdi:stove'
        color:
          type: string
          description: Color hex code
          example: '#FF5722'
        status:
          type: string
          enum: [active, inactive, pending]
          description: Tag status

    SetAssignmentRequest:
      type: object
      required:
        - subject
        - tag_keys
      properties:
        subject:
          type: string
          description: Entity ID or subject identifier
          example: 'light.kitchen_main'
        tag_keys:
          type: array
          items:
            type: string
          description: List of tag keys to assign
          example: ['aicp.place.kueche', 'aicp.kind.light']

    ConfirmTagRequest:
      type: object
      required:
        - tag_key
      properties:
        tag_key:
          type: string
          description: Tag key to confirm

    PullFromCoreRequest:
      type: object
      properties:
        entry_id:
          type: string
          description: Optional config entry ID

    # ---------- OPS RUNBOOK ----------
    ExecuteActionRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          description: Action identifier
          enum: [restart_forwarder, sync_tags, reset_cache, health_check]

    RunChecklistRequest:
      type: object
      required:
        - checklist
      properties:
        checklist:
          type: string
          description: Checklist name
          enum: [full_health, connectivity, data_integrity, performance]

    # ---------- MUPL ----------
    LearnPreferenceRequest:
      type: object
      required:
        - user_id
        - preference_type
        - value
      properties:
        user_id:
          type: string
          description: Home Assistant user ID
        preference_type:
          type: string
          enum: [comfort, frugality, joy]
          description: Preference type
        value:
          oneOf:
            - type: number
              minimum: 0
              maximum: 1
            - type: object
              description: Zone-specific preference values
          description: Preference value (0.0-1.0) or zone mapping
        zone:
          type: string
          description: Optional zone ID for zone-specific preference

    SetUserPriorityRequest:
      type: object
      required:
        - user_id
        - priority
      properties:
        user_id:
          type: string
          description: Home Assistant user ID
        priority:
          type: number
          minimum: 0
          maximum: 1
          description: User priority (0.0-1.0)

    GetAggregatedMoodRequest:
      type: object
      properties:
        user_ids:
          type: array
          items:
            type: string
          description: List of user IDs to aggregate mood for