<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PilotSuite — Styx</title>
<style>
:root{--bg:#0a0e14;--surface:#12171f;--card:#171d27;--border:#1e2a3a;--text:#e0e6ed;--dim:#6b7a8d;--accent:#7c6aef;--accent2:#9b8afb;--green:#34d399;--yellow:#fbbf24;--red:#f87171;--blue:#60a5fa;--cyan:#22d3ee;--orange:#fb923c;--pink:#f472b6;--radius:12px;--shadow:0 4px 20px rgba(0,0,0,.5)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
a{color:var(--blue);text-decoration:none}a:hover{text-decoration:underline}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Header */
.header{background:linear-gradient(180deg,var(--surface) 0%,rgba(18,23,31,.95) 100%);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100;backdrop-filter:blur(12px)}
.header .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#5b4cd4);display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 2px 12px rgba(124,106,239,.3)}
.header h1{font-size:18px;font-weight:700;flex:1;background:linear-gradient(135deg,var(--accent2),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header .status-pill{display:flex;align-items:center;gap:6px;font-size:12px;padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:var(--card)}
.header .dot{width:7px;height:7px;border-radius:50%;animation:pulse 2s infinite}
.dot-green{background:var(--green)}.dot-yellow{background:var(--yellow)}.dot-red{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.header .ver{font-size:11px;color:var(--dim);padding:3px 8px;border-radius:12px;border:1px solid var(--border)}

/* Nav */
.nav{background:var(--surface);border-bottom:1px solid var(--border);display:flex;overflow-x:auto;padding:0 12px;gap:2px}
.nav button{background:none;border:none;color:var(--dim);padding:10px 16px;font-size:12px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:.2s;letter-spacing:.3px;text-transform:uppercase}
.nav button:hover{color:var(--text)}.nav button.active{color:var(--accent2);border-bottom-color:var(--accent)}

/* Layout */
.page{display:none;padding:16px;max-width:1600px;margin:0 auto}.page.active{display:block}
.grid{display:grid;gap:14px}.g2{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}.g3{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}.g4{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);transition:border-color .2s}
.card:hover{border-color:rgba(124,106,239,.3)}
.card h2{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:7px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.card h2 .ic{font-size:16px}

/* Stat */
.stat{text-align:center;padding:12px 8px}.stat .v{font-size:32px;font-weight:800;background:linear-gradient(135deg,var(--accent2),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.stat .l{font-size:10px;color:var(--dim);margin-top:3px;text-transform:uppercase;letter-spacing:.8px}

/* Badge */
.b{display:inline-block;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:600;letter-spacing:.3px}
.b-g{background:rgba(52,211,153,.12);color:var(--green)}.b-y{background:rgba(251,191,36,.12);color:var(--yellow)}
.b-r{background:rgba(248,113,113,.12);color:var(--red)}.b-b{background:rgba(96,165,250,.12);color:var(--blue)}
.b-p{background:rgba(124,106,239,.12);color:var(--accent2)}.b-c{background:rgba(34,211,238,.12);color:var(--cyan)}

/* Table */
.tbl{width:100%;border-collapse:collapse;font-size:12px}
.tbl th{text-align:left;padding:6px 10px;color:var(--dim);font-weight:500;border-bottom:1px solid var(--border);font-size:10px;text-transform:uppercase;letter-spacing:.5px}
.tbl td{padding:7px 10px;border-bottom:1px solid rgba(30,42,58,.5)}

/* Gauge */
.gauge{margin:6px 0}.gauge-hd{display:flex;justify-content:space-between;font-size:11px;color:var(--dim);margin-bottom:3px}
.gauge-hd .gv{color:var(--text);font-weight:600}
.gauge-bar{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.gauge-fill{height:100%;border-radius:3px;transition:width .8s ease}

/* Pattern */
.pat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin:6px 0;display:flex;align-items:center;gap:10px;font-size:12px}
.pat .arr{color:var(--accent2);font-weight:700;flex-shrink:0}.pat .meta{margin-left:auto;color:var(--dim);font-size:11px;white-space:nowrap}

/* ============== STYX PAGE: Brain + Chat + History ============== */
.styx-layout{display:grid;grid-template-columns:1fr 380px;grid-template-rows:auto 1fr auto;gap:14px;height:calc(100vh - 120px);min-height:500px}
.styx-brain{grid-column:1;grid-row:1/4;display:flex;flex-direction:column;gap:12px}
.styx-right{grid-column:2;grid-row:1/4;display:flex;flex-direction:column;gap:12px;min-height:0}

/* Brain container */
.brain-wrap{flex:1;min-height:300px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);position:relative;overflow:hidden}
.brain-wrap svg{width:100%;height:100%;display:block}
.brain-legend{position:absolute;top:10px;left:10px;display:flex;flex-wrap:wrap;gap:6px;z-index:5}
.brain-legend .leg{font-size:9px;display:flex;align-items:center;gap:4px;background:rgba(10,14,20,.8);padding:3px 8px;border-radius:6px;border:1px solid var(--border)}
.brain-legend .leg .dot-lg{width:8px;height:8px;border-radius:50%}
.brain-controls{position:absolute;top:10px;right:10px;display:flex;gap:4px;z-index:5}
.brain-controls button{background:var(--card);border:1px solid var(--border);color:var(--dim);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:12px}
.brain-controls button:hover{color:var(--text);border-color:var(--accent)}

/* Module pipeline indicators */
.pipelines{display:flex;gap:6px;flex-wrap:wrap;padding:4px 0}
.pipe{display:flex;align-items:center;gap:5px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:10px;cursor:pointer;transition:.2s}
.pipe:hover{border-color:var(--accent)}
.pipe .pd{width:6px;height:6px;border-radius:50%}
.pipe-active .pd{background:var(--green)}.pipe-learning .pd{background:var(--yellow);animation:pulse 1.5s infinite}.pipe-off .pd{background:var(--dim)}
.pipe span{color:var(--dim)}.pipe-active span{color:var(--green)}.pipe-learning span{color:var(--yellow)}

/* Chat panel */
.chat-panel{display:flex;flex-direction:column;flex:1;min-height:0;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.chat-hd{padding:10px 14px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;display:flex;align-items:center;gap:8px;color:var(--accent2);flex-shrink:0}
.chat-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;min-height:0}
.msg{max-width:85%;padding:8px 12px;border-radius:10px;font-size:13px;line-height:1.5;word-wrap:break-word}
.msg.u{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#5b4cd4);color:#fff;border-bottom-right-radius:3px}
.msg.a{align-self:flex-start;background:var(--surface);border:1px solid var(--border);border-bottom-left-radius:3px}
.chat-in{display:flex;gap:6px;padding:10px;border-top:1px solid var(--border);flex-shrink:0}
.chat-in input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-size:13px;outline:none}
.chat-in input:focus{border-color:var(--accent)}
.chat-in button{background:linear-gradient(135deg,var(--accent),#5b4cd4);color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:12px;font-weight:600}
.chat-in button:disabled{opacity:.4;cursor:not-allowed}

/* History panel */
.history-panel{max-height:180px;overflow-y:auto;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);flex-shrink:0}
.history-panel .hd{padding:8px 14px;font-size:11px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--card);z-index:1}
.hist-item{padding:6px 14px;font-size:11px;border-bottom:1px solid rgba(30,42,58,.3);display:flex;gap:8px;align-items:center}
.hist-item .ht{color:var(--dim);font-size:10px;flex-shrink:0;width:40px}

/* Suggestions bar */
.suggest-bar{display:flex;gap:8px;overflow-x:auto;padding:8px 0;flex-shrink:0}
.suggest-btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:6px 14px;border-radius:20px;font-size:11px;cursor:pointer;white-space:nowrap;transition:.2s}
.suggest-btn:hover{border-color:var(--accent);background:rgba(124,106,239,.08)}

/* ============== MODULE PAGE ============== */
.mod-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;display:flex;align-items:center;gap:12px}
.mod-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.mod-info{flex:1;min-width:0}.mod-info h3{font-size:13px;font-weight:600}.mod-info p{font-size:11px;color:var(--dim);margin-top:2px}
.mod-status{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.mod-toggle{width:36px;height:20px;border-radius:10px;border:none;cursor:pointer;position:relative;transition:.2s}
.mod-toggle.on{background:var(--green)}.mod-toggle.learn{background:var(--yellow)}.mod-toggle.off{background:var(--dim)}
.mod-toggle::after{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;top:2px;transition:.2s}
.mod-toggle.on::after,.mod-toggle.learn::after{left:18px}.mod-toggle.off::after{left:2px}

/* ============== HABITUS PAGE ============== */
.zone-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.zone-card h3{font-size:14px;font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.zone-entities{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
.zone-entities .ze{font-size:10px;background:var(--surface);border:1px solid var(--border);padding:3px 8px;border-radius:6px;color:var(--dim)}

/* ============== TREND CHART ============== */
.trend-chart{width:100%;height:120px;position:relative}
.trend-chart canvas{width:100%;height:100%}

/* Loading / Empty */
.loading{display:flex;align-items:center;justify-content:center;padding:30px;color:var(--dim);font-size:12px}
.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:30px;color:var(--dim);font-size:12px;line-height:1.6}

/* Responsive */
@media(max-width:900px){
  .styx-layout{grid-template-columns:1fr;grid-template-rows:auto auto auto;height:auto}
  .styx-brain{grid-column:1;grid-row:1}
  .styx-right{grid-column:1;grid-row:2/4}
  .brain-wrap{min-height:250px}
}
@media(max-width:600px){.g2,.g3,.g4{grid-template-columns:1fr}.header h1{font-size:15px}}

/* Onboard */
.onboard{background:linear-gradient(135deg,rgba(124,106,239,.08),rgba(34,211,238,.05));border:1px solid rgba(124,106,239,.25);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.onboard h2{font-size:16px;font-weight:700;margin-bottom:6px;background:linear-gradient(135deg,var(--accent2),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.onboard p{color:var(--dim);font-size:13px;line-height:1.6}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
<div class="logo">&#x2726;</div>
<h1 id="app-title">Styx — PilotSuite</h1>
<span class="status-pill" id="provider-status"><span class="dot dot-yellow" id="status-dot"></span><span id="status-text">Verbinde...</span></span>
<span class="ver" id="ver-badge">v1.0.0</span>
</div>

<!-- Navigation -->
<div class="nav" id="nav">
<button class="active" data-page="styx">Styx</button>
<button data-page="habitus">Habitus</button>
<button data-page="mood">Stimmung</button>
<button data-page="modules">Module</button>
<button data-page="settings">Einstellungen</button>
</div>

<!-- ========== STYX PAGE: Brain + Chat + History ========== -->
<div class="page active" id="page-styx">
<!-- Module Pipelines -->
<div class="pipelines" id="pipelines"></div>
<!-- Main Layout -->
<div class="styx-layout">
  <!-- LEFT: Brain Graph -->
  <div class="styx-brain">
    <div class="brain-wrap" id="brain-canvas">
      <div class="brain-legend" id="brain-legend"></div>
      <div class="brain-controls"><button onclick="reloadBrain()" title="Neu laden">&#x21bb;</button></div>
      <div class="loading"><div class="spinner"></div>Brain Graph laden...</div>
    </div>
    <!-- Suggestions -->
    <div class="suggest-bar" id="suggestions">
      <span class="suggest-btn" onclick="navigateTo('habitus')">Habitus erkunden</span>
      <span class="suggest-btn" onclick="navigateTo('mood')">Stimmung pruefen</span>
      <span class="suggest-btn" onclick="navigateTo('modules')">Module verwalten</span>
      <span class="suggest-btn" onclick="window.open('/api/v1/docs/','_blank')">API Docs</span>
    </div>
  </div>
  <!-- RIGHT: Chat + History -->
  <div class="styx-right">
    <!-- Chat -->
    <div class="chat-panel">
      <div class="chat-hd"><span>&#x2726;</span> <span id="assistant-name">Styx</span> <span class="b b-p" id="chat-model">--</span></div>
      <div class="chat-msgs" id="chat-msgs">
        <div class="msg a" id="styx-greeting">Hallo! Ich bin <strong>Styx</strong>, dein PilotSuite Assistent. Ich verbinde dein Smart Home mit lokaler KI. Wie kann ich helfen?</div>
      </div>
      <div class="chat-in">
        <input type="text" id="chat-input" placeholder="Frag Styx..." autocomplete="off">
        <button id="chat-send" onclick="sendChat()">&#x2728;</button>
      </div>
    </div>
    <!-- History -->
    <div class="history-panel" id="history-panel">
      <div class="hd">Verlauf &amp; Aktivitaet</div>
      <div id="history-items"><div class="hist-item"><span class="ht">jetzt</span><span>PilotSuite gestartet</span></div></div>
    </div>
  </div>
</div>
</div>

<!-- ========== HABITUS PAGE ========== -->
<div class="page" id="page-habitus">
<div class="grid g2" style="margin-bottom:14px">
  <div class="card">
    <h2><span class="ic">&#x1f50d;</span> Verhaltens-Muster</h2>
    <div class="b b-b" id="hab-count" style="margin-bottom:10px">-- Regeln</div>
    <div id="hab-rules"><div class="loading"><div class="spinner"></div>Lade...</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f3e0;</span> Habitus-Zonen</h2>
    <div id="hab-zones"><div class="loading"><div class="spinner"></div>Lade Zonen...</div></div>
  </div>
</div>
<div class="card">
  <h2><span class="ic">&#x1f4c8;</span> Pattern Trend (letzte 24h)</h2>
  <div class="trend-chart" id="hab-trend"><canvas id="hab-trend-canvas"></canvas></div>
</div>
</div>

<!-- ========== MOOD PAGE ========== -->
<div class="page" id="page-mood">
<div class="card" style="margin-bottom:14px">
  <h2><span class="ic">&#x1f3b5;</span> Stimmungs-Zonen</h2>
  <div id="mood-zones"><div class="loading"><div class="spinner"></div>Lade...</div></div>
</div>
<div class="grid g3" id="mood-stats"></div>
<div class="card" style="margin-top:14px">
  <h2><span class="ic">&#x1f4ca;</span> Mood Trend</h2>
  <div class="trend-chart" id="mood-trend"><canvas id="mood-trend-canvas"></canvas></div>
</div>
</div>

<!-- ========== MODULES PAGE ========== -->
<div class="page" id="page-modules">
<div class="card" style="margin-bottom:14px">
  <h2><span class="ic">&#x2699;&#xfe0f;</span> Neurale Pipeline</h2>
  <p style="font-size:12px;color:var(--dim);margin-bottom:12px">Module steuern wie Styx dein Zuhause wahrnimmt. Aktive Module lernen automatisch, lernende Module fragen nach.</p>
</div>
<div class="grid g2" id="module-list"></div>
</div>

<!-- ========== SETTINGS PAGE ========== -->
<div class="page" id="page-settings">
<div class="grid g2">
  <div class="card">
    <h2><span class="ic">&#x1f9e0;</span> LLM &amp; KI</h2>
    <table class="tbl" id="set-llm"></table>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f4e6;</span> Ollama Modelle</h2>
    <div id="set-models"><div class="loading"><div class="spinner"></div>Lade...</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f4f1;</span> System Status</h2>
    <table class="tbl" id="set-system"></table>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f517;</span> API Endpoints</h2>
    <table class="tbl">
      <tr><td>Chat (OpenAI)</td><td><code>/v1/chat/completions</code></td></tr>
      <tr><td>Modelle</td><td><code>/v1/models</code></td></tr>
      <tr><td>MCP Server</td><td><code>/mcp</code></td></tr>
      <tr><td>Brain Graph</td><td><code>/api/v1/graph/state</code></td></tr>
      <tr><td>Habitus</td><td><code>/api/v1/habitus/rules</code></td></tr>
      <tr><td>Mood</td><td><code>/api/v1/mood/state</code></td></tr>
      <tr><td>Neuronen</td><td><code>/api/v1/neurons</code></td></tr>
      <tr><td>Telegram</td><td><code>/telegram/status</code></td></tr>
      <tr><td>API Docs</td><td><a href="/api/v1/docs/" target="_blank">/api/v1/docs/</a></td></tr>
    </table>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f4da;</span> Gedaechtnis</h2>
    <div id="set-memory"><div class="loading"><div class="spinner"></div>Lade...</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#x1f916;</span> Empfohlene Modelle</h2>
    <div id="set-rec"><div class="loading"><div class="spinner"></div>Lade...</div></div>
  </div>
</div>
</div>

<script>
// ==================================================
// PilotSuite Dashboard — Styx v1.0.0
// ==================================================
const API='';
const DOMAIN_COLORS={
  sensor:'#34d399',light:'#fbbf24',switch:'#7c6aef',binary_sensor:'#60a5fa',
  climate:'#f87171',media_player:'#fb923c',automation:'#9b8afb',camera:'#f472b6',
  cover:'#22d3ee',fan:'#34d399',input_boolean:'#818cf8',script:'#a78bfa',
  person:'#fbbf24',weather:'#60a5fa',scene:'#f472b6',default:'#6b7a8d'
};
const MODULE_DEFS=[
  {id:'brain_graph',name:'Brain Graph',desc:'Entity-Beziehungen erkennen',icon:'&#x1f9e0;',color:'var(--accent)'},
  {id:'habitus_miner',name:'Habitus Miner',desc:'A->B Muster finden',icon:'&#x1f50d;',color:'var(--cyan)'},
  {id:'mood_engine',name:'Mood Engine',desc:'Comfort/Joy/Frugality bewerten',icon:'&#x1f3b5;',color:'var(--yellow)'},
  {id:'event_forwarder',name:'Event Forwarder',desc:'HA-Events an Core weiterleiten',icon:'&#x26a1;',color:'var(--green)'},
  {id:'neurons',name:'Neuronen (14x)',desc:'Kontext-Signale (Presence, Energy...)',icon:'&#x1f4a1;',color:'var(--orange)'},
  {id:'knowledge_graph',name:'Knowledge Graph',desc:'Semantisches Entity-Netzwerk',icon:'&#x1f310;',color:'var(--blue)'},
  {id:'conversation_memory',name:'Gedaechtnis',desc:'Lifelong Learning SQLite',icon:'&#x1f4da;',color:'var(--pink)'},
  {id:'media_context',name:'Media Context',desc:'Musik/TV/Sonos Tracking',icon:'&#x1f3b6;',color:'var(--orange)'},
  {id:'energy_context',name:'Energy Monitor',desc:'PV, Grid, Verbrauch',icon:'&#x26a1;',color:'var(--green)'},
  {id:'weather_context',name:'Wetter',desc:'Wetter-Integration',icon:'&#x26c5;',color:'var(--blue)'},
  {id:'unifi_context',name:'UniFi Netzwerk',desc:'WLAN-Qualitaet, Praesenz',icon:'&#x1f4f6;',color:'var(--cyan)'},
  {id:'camera_context',name:'Kamera',desc:'Bewegung & Praesenz',icon:'&#x1f4f7;',color:'var(--pink)'},
  {id:'user_preferences',name:'Nutzer-Praeferenzen',desc:'Multi-User Learning (MUPL)',icon:'&#x1f464;',color:'var(--accent2)'},
  {id:'telegram_bot',name:'Telegram Bot',desc:'Chat-Bridge + Notifications',icon:'&#x2709;',color:'var(--blue)'},
  {id:'mcp_server',name:'MCP Server',desc:'Skills fuer externe KI-Clients',icon:'&#x1f50c;',color:'var(--accent)'},
];

// State
let chatHistory=[];
let historyLog=[];
let moduleStates={};

// -- Helpers --
function $(id){return document.getElementById(id)}
async function api(path){try{const r=await fetch(API+path);if(!r.ok)return null;return await r.json()}catch(e){return null}}
function badge(t,c){return `<span class="b b-${c}">${t}</span>`}
function el(tag,cls,html){const e=document.createElement(tag);if(cls)e.className=cls;if(html)e.innerHTML=html;return e}
function addHistory(text){
  const now=new Date();const t=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  historyLog.unshift({time:t,text});
  renderHistory();
}
function renderHistory(){
  const c=$('history-items');if(!c)return;
  c.innerHTML=historyLog.slice(0,30).map(h=>`<div class="hist-item"><span class="ht">${h.time}</span><span>${h.text}</span></div>`).join('');
}

// -- Navigation --
document.querySelectorAll('.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');$('page-'+btn.dataset.page).classList.add('active');
    loadPage(btn.dataset.page);
  });
});
function navigateTo(p){
  document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active',b.dataset.page===p));
  document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
  $('page-'+p).classList.add('active');loadPage(p);
}

// ==================================================
// STYX PAGE (Brain + Chat + History)
// ==================================================
async function loadStyx(){
  // Load status
  const status=await api('/chat/status');
  if(status){
    const dot=$('status-dot'),txt=$('status-text');
    if(status.available){dot.className='dot dot-green';txt.textContent='Online'}
    else{dot.className='dot dot-red';txt.textContent='Offline'}
    $('chat-model').textContent=status.model||'--';
    // Set assistant name from status if available
    const name=status.assistant_name||'Styx';
    $('assistant-name').textContent=name;
    $('app-title').textContent=name+' \u2014 PilotSuite';
    document.title='PilotSuite \u2014 '+name;
  }
  // Load pipelines
  loadPipelines(status);
  // Load brain
  loadBrainGraph();
  // Load suggestions from habitus
  loadSuggestions();
  addHistory('Dashboard geladen');
}

function loadPipelines(status){
  const c=$('pipelines');if(!c)return;
  const neuronData=status?.neurons_active||0;
  const tgOk=status?.telegram_running||false;
  c.innerHTML='';
  MODULE_DEFS.forEach(m=>{
    let st='active';
    if(m.id==='telegram_bot'&&!tgOk)st='off';
    moduleStates[m.id]=st;
    const d=el('div','pipe pipe-'+st,`<span class="pd"></span><span>${m.name}</span>`);
    d.onclick=()=>navigateTo('modules');
    c.appendChild(d);
  });
}

// -- Brain Graph --
let brainNodes=[],brainEdges=[];
async function loadBrainGraph(){
  const data=await api('/api/v1/graph/state?limitNodes=120&limitEdges=300');
  const c=$('brain-canvas');
  if(!data||!data.nodes||!data.nodes.length){
    c.querySelector('.loading')||null;
    const inner=c.querySelector('.loading');
    if(inner)inner.innerHTML='<div class="empty">Brain Graph ist noch leer.<br>Events von HA werden automatisch verarbeitet.</div>';
    return;
  }
  brainNodes=data.nodes;brainEdges=data.edges||[];
  addHistory(brainNodes.length+' Brain-Nodes geladen');
  renderBrain(c,brainNodes,brainEdges);
  renderLegend();
}
function reloadBrain(){loadBrainGraph()}

function renderBrain(container,nodes,edges){
  const rect=container.getBoundingClientRect();
  const W=rect.width||800,H=rect.height||500;
  const nodeMap={};
  nodes.forEach(n=>{
    n.x=W/2+(Math.random()-.5)*W*.7;n.y=H/2+(Math.random()-.5)*H*.7;n.vx=0;n.vy=0;
    nodeMap[n.id||n.entity_id]=n;
  });
  // Force simulation
  for(let iter=0;iter<120;iter++){
    for(let i=0;i<nodes.length;i++){
      for(let j=i+1;j<nodes.length;j++){
        let dx=nodes[j].x-nodes[i].x,dy=nodes[j].y-nodes[i].y;
        let d=Math.sqrt(dx*dx+dy*dy)||1;
        let f=1000/(d*d);
        nodes[i].vx-=dx/d*f;nodes[i].vy-=dy/d*f;
        nodes[j].vx+=dx/d*f;nodes[j].vy+=dy/d*f;
      }
    }
    edges.forEach(e=>{
      const s=nodeMap[e.source||e.from],t=nodeMap[e.target||e.to];
      if(!s||!t)return;
      let dx=t.x-s.x,dy=t.y-s.y,d=Math.sqrt(dx*dx+dy*dy)||1;
      let f=(d-90)*.008;
      s.vx+=dx/d*f;s.vy+=dy/d*f;t.vx-=dx/d*f;t.vy-=dy/d*f;
    });
    nodes.forEach(n=>{
      n.vx+=(W/2-n.x)*.0008;n.vy+=(H/2-n.y)*.0008;
      n.vx*=.82;n.vy*=.82;
      n.x+=n.vx;n.y+=n.vy;
      n.x=Math.max(25,Math.min(W-25,n.x));n.y=Math.max(25,Math.min(H-25,n.y));
    });
  }
  // SVG
  let svg=`<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
  svg+=`<defs><filter id="glow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>`;
  // Edges
  edges.forEach(e=>{
    const s=nodeMap[e.source||e.from],t=nodeMap[e.target||e.to];
    if(!s||!t)return;
    const w=Math.max(.3,Math.min(2.5,(e.weight||.5)*3));
    svg+=`<line x1="${s.x}" y1="${s.y}" x2="${t.x}" y2="${t.y}" stroke="#1e2a3a" stroke-width="${w}" stroke-opacity=".4"/>`;
  });
  // Nodes
  nodes.forEach(n=>{
    const domain=(n.id||n.entity_id||'').split('.')[0];
    const color=DOMAIN_COLORS[domain]||DOMAIN_COLORS.default;
    const r=4+Math.min(10,(n.score||.5)*7);
    const label=(n.id||n.entity_id||'').split('.').pop().replace(/_/g,' ').slice(0,18);
    svg+=`<circle cx="${n.x}" cy="${n.y}" r="${r}" fill="${color}" opacity=".8" filter="url(#glow)"/>`;
    if(r>6)svg+=`<text x="${n.x}" y="${n.y+r+10}" text-anchor="middle" fill="#6b7a8d" font-size="7.5" font-family="Inter,sans-serif">${label}</text>`;
  });
  svg+='</svg>';
  // Keep legend and controls
  const legend=container.querySelector('.brain-legend');
  const controls=container.querySelector('.brain-controls');
  container.innerHTML=svg;
  if(legend)container.appendChild(legend);
  if(controls)container.appendChild(controls);
}

function renderLegend(){
  const c=$('brain-legend');if(!c)return;
  const domains={};
  brainNodes.forEach(n=>{const d=(n.id||n.entity_id||'').split('.')[0];domains[d]=(domains[d]||0)+1});
  c.innerHTML='';
  Object.entries(domains).sort((a,b)=>b[1]-a[1]).slice(0,8).forEach(([d,cnt])=>{
    const color=DOMAIN_COLORS[d]||DOMAIN_COLORS.default;
    c.innerHTML+=`<div class="leg"><span class="dot-lg" style="background:${color}"></span>${d} (${cnt})</div>`;
  });
}

// -- Chat --
const chatInput=$('chat-input');
chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat()}});

async function sendChat(){
  const input=$('chat-input'),msg=input.value.trim();
  if(!msg)return;
  input.value='';
  const msgs=$('chat-msgs');
  msgs.appendChild(el('div','msg u',msg));msgs.scrollTop=msgs.scrollHeight;
  chatHistory.push({role:'user',content:msg});
  addHistory('Chat: '+msg.slice(0,40)+(msg.length>40?'...':''));
  const btn=$('chat-send');btn.disabled=true;
  const typing=el('div','msg a','<div class="spinner" style="display:inline-block;width:12px;height:12px;margin-right:6px"></div>Denkt nach...');
  msgs.appendChild(typing);msgs.scrollTop=msgs.scrollHeight;
  try{
    const r=await fetch(API+'/v1/chat/completions',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'',messages:chatHistory.slice(-10),stream:false})
    });
    const data=await r.json();
    const reply=data?.choices?.[0]?.message?.content||data?.error?.message||'Keine Antwort.';
    typing.innerHTML=reply.replace(/\n/g,'<br>');
    chatHistory.push({role:'assistant',content:reply});
    addHistory('Styx: '+reply.slice(0,40)+(reply.length>40?'...':''));
  }catch(e){typing.textContent='Fehler: '+e.message}
  btn.disabled=false;msgs.scrollTop=msgs.scrollHeight;
}

// -- Suggestions --
async function loadSuggestions(){
  const data=await api('/api/v1/habitus/rules?limit=3');
  const rules=data?.rules||data?.data||[];
  const c=$('suggestions');if(!c||!rules.length)return;
  c.innerHTML='';
  rules.slice(0,3).forEach(r=>{
    const meta=r.metadata||r;
    const ant=meta.antecedent?.full||meta.antecedent||'?';
    const cons=meta.consequent?.full||meta.consequent||'?';
    const btn=el('span','suggest-btn',`${ant} \u2192 ${cons}`);
    btn.onclick=()=>{$('chat-input').value=`Erklaere das Muster: ${ant} -> ${cons}`;sendChat()};
    c.appendChild(btn);
  });
  // Add defaults
  ['Habitus erkunden','Stimmung pruefen','Module verwalten'].forEach((t,i)=>{
    const targets=['habitus','mood','modules'];
    c.appendChild(Object.assign(el('span','suggest-btn',t),{onclick:()=>navigateTo(targets[i])}));
  });
}

// ==================================================
// HABITUS
// ==================================================
async function loadHabitus(){
  const data=await api('/api/v1/habitus/rules?limit=50');
  const rules=data?.rules||data?.data||[];
  $('hab-count').textContent=rules.length+' Regeln';
  const c=$('hab-rules');
  if(!rules.length){c.innerHTML='<div class="empty">Noch keine Muster. PilotSuite lernt automatisch aus Events.</div>';return}
  c.innerHTML='';
  rules.forEach(r=>{
    const m=r.metadata||r;
    const ant=m.antecedent?.full||m.antecedent||'?';
    const cons=m.consequent?.full||m.consequent||'?';
    const conf=((m.confidence||0)*100).toFixed(0);
    const supp=((m.support||0)*100).toFixed(1);
    const lift=(m.lift||0).toFixed(2);
    c.appendChild(el('div','pat',
      `<span>${ant}</span><span class="arr">\u2192</span><span>${cons}</span><span class="meta">${conf}% | ${supp}% Supp | Lift ${lift}</span>`));
  });
  // Zones
  const zones=await api('/api/v1/habitus/config');
  const zc=$('hab-zones');
  if(zones&&zones.zones){
    zc.innerHTML='';
    Object.entries(zones.zones).forEach(([id,z])=>{
      const card=el('div','zone-card',
        `<h3><span style="color:var(--cyan)">&#x1f3e0;</span> ${z.name||id}</h3>
        <p style="font-size:11px;color:var(--dim)">${z.description||'Zone: '+id}</p>
        <div class="zone-entities">${(z.entities||[]).map(e=>`<span class="ze">${e}</span>`).join('')}</div>`);
      zc.appendChild(card);
    });
  }else{
    zc.innerHTML='<div class="empty">Keine Zonen konfiguriert. Zonen werden in HA Options definiert.</div>';
  }
  // Trend (simple placeholder)
  drawTrend('hab-trend-canvas',rules.length);
}

// ==================================================
// MOOD
// ==================================================
async function loadMood(){
  const data=await api('/api/v1/mood/state');
  const c=$('mood-zones'),sc=$('mood-stats');
  if(!data||!data.zones){c.innerHTML='<div class="empty">Noch keine Stimmungsdaten. Mood Engine benoetigt Events aus Zonen.</div>';return}
  c.innerHTML='';
  const zones=Object.entries(data.zones||{});
  if(!zones.length){c.innerHTML='<div class="empty">Keine Zonen konfiguriert.</div>';return}
  zones.forEach(([name,z])=>{
    const comfort=z.comfort||0,joy=z.joy||0,frug=z.frugality||0;
    c.appendChild(el('div','',
      `<h3 style="font-size:13px;margin:12px 0 6px;font-weight:600">${name}</h3>`+
      gaugeHTML('Comfort',comfort,'var(--green)')+gaugeHTML('Joy',joy,'var(--yellow)')+gaugeHTML('Frugality',frug,'var(--accent)')));
  });
  if(data.summary){
    sc.innerHTML=
      `<div class="card stat"><div class="v">${(data.summary.average_comfort||0).toFixed(1)}</div><div class="l">Avg Comfort</div></div>`+
      `<div class="card stat"><div class="v">${(data.summary.average_joy||0).toFixed(1)}</div><div class="l">Avg Joy</div></div>`+
      `<div class="card stat"><div class="v">${(data.summary.average_frugality||0).toFixed(1)}</div><div class="l">Avg Frugality</div></div>`;
  }
  drawTrend('mood-trend-canvas',zones.length*3);
}
function gaugeHTML(label,val,color){
  const pct=Math.max(0,Math.min(100,val*100));
  return `<div class="gauge"><div class="gauge-hd"><span>${label}</span><span class="gv">${pct.toFixed(0)}%</span></div><div class="gauge-bar"><div class="gauge-fill" style="width:${pct}%;background:${color}"></div></div></div>`;
}

// ==================================================
// MODULES
// ==================================================
async function loadModules(){
  const c=$('module-list');if(!c)return;
  c.innerHTML='';
  // Get neuron data
  const neurons=await api('/api/v1/neurons');
  const neuronList=neurons?.neurons||neurons?.data||[];
  const status=await api('/chat/status');
  const tgStatus=await api('/telegram/status');
  MODULE_DEFS.forEach(m=>{
    let st='active';let detail='';
    if(m.id==='telegram_bot'){st=tgStatus?.running?'active':'off';detail=tgStatus?.running?'Polling aktiv':'Nicht konfiguriert'}
    else if(m.id==='neurons'){detail=neuronList.length+' aktiv'}
    else if(m.id==='conversation_memory'){detail=status?.memory_entries?status.memory_entries+' Eintraege':'Bereit'}
    else{detail='Aktiv'}
    const card=el('div','mod-card',
      `<div class="mod-icon" style="background:${m.color}20;color:${m.color}">${m.icon}</div>
      <div class="mod-info"><h3>${m.name}</h3><p>${m.desc}</p><div style="margin-top:4px">${badge(detail,st==='active'?'g':st==='learning'?'y':'r')}</div></div>
      <div class="mod-status"><button class="mod-toggle ${st==='active'?'on':st==='learning'?'learn':'off'}" title="${st}"></button><span style="font-size:9px;color:var(--dim)">${st}</span></div>`);
    c.appendChild(card);
  });
}

// ==================================================
// SETTINGS
// ==================================================
async function loadSettings(){
  const status=await api('/chat/status');
  if(status){
    $('set-llm').innerHTML=
      `<tr><td>Provider</td><td>${badge(status.active_provider||'--','p')}</td></tr>`+
      `<tr><td>Modell</td><td><strong>${status.model||'--'}</strong></td></tr>`+
      `<tr><td>Assistent</td><td><strong>${status.assistant_name||'Styx'}</strong></td></tr>`+
      `<tr><td>Ollama</td><td>${status.ollama_available?badge('Online','g'):badge('Offline','r')}</td></tr>`+
      `<tr><td>Cloud API</td><td>${status.cloud_configured?badge('Konfiguriert','b'):badge('Nicht konfiguriert','y')}</td></tr>`+
      `<tr><td>Lokal bevorzugen</td><td>${status.prefer_local?badge('Ja','g'):badge('Nein','y')}</td></tr>`+
      `<tr><td>Charakter</td><td>${status.character||'copilot'}</td></tr>`+
      `<tr><td>Anfragen/h</td><td>${status.calls_this_hour||0} / ${status.max_calls_per_hour||60}</td></tr>`;
    // Models
    const models=status.installed_models||[];
    const mc=$('set-models');
    if(!models.length){mc.innerHTML='<div class="empty">Keine Modelle installiert</div>'}
    else{mc.innerHTML='';models.forEach(m=>{mc.appendChild(el('div','pat',`<span>${m}</span><span class="meta">${m===status.model?badge('Aktiv','g'):''}</span>`))})}
    // System
    const tg=await api('/telegram/status');
    $('set-system').innerHTML=
      `<tr><td>Version</td><td>${badge('v1.0.0','p')}</td></tr>`+
      `<tr><td>Ollama URL</td><td><code>${status.ollama_url||'localhost:11434'}</code></td></tr>`+
      `<tr><td>Cloud URL</td><td><code>${status.cloud_api_url||'--'}</code></td></tr>`+
      `<tr><td>Telegram</td><td>${tg?.running?badge('Aktiv','g'):badge('Aus','y')}</td></tr>`+
      `<tr><td>MCP Server</td><td>${badge('Aktiv','g')}</td></tr>`;
  }
  // Memory
  const mem=await api('/chat/memory');
  const mc2=$('set-memory');
  if(mem&&mem.stats){
    mc2.innerHTML=`<table class="tbl">
      <tr><td>Nachrichten</td><td><strong>${mem.stats.total_messages||0}</strong></td></tr>
      <tr><td>Praeferenzen</td><td><strong>${(mem.preferences||[]).length}</strong></td></tr>
      <tr><td>Themen</td><td><strong>${mem.stats.topics_count||0}</strong></td></tr>
      <tr><td>Speicher</td><td>${mem.stats.db_size_mb?mem.stats.db_size_mb.toFixed(1)+' MB':'--'}</td></tr>
    </table>`;
  }else{mc2.innerHTML='<div class="empty">Gedaechtnis nicht initialisiert</div>'}
  // Recommended
  const rec=await api('/chat/models/recommended');
  const rc=$('set-rec');
  if(rec&&rec.models){
    rc.innerHTML='';
    rec.models.forEach(m=>{
      const badges=[m.installed?badge('Installiert','g'):badge(m.size_mb+'MB','y')];
      if(m.active)badges.push(badge('Aktiv','p'));
      if(m.supports_tools)badges.push(badge('Tools','b'));
      rc.appendChild(el('div','pat',
        `<div><strong>${m.name}</strong><br><span style="font-size:10px;color:var(--dim)">${m.description}</span></div>
        <div class="meta">${badges.join(' ')}</div>`));
    });
  }
}

// ==================================================
// TREND CHART (mini canvas)
// ==================================================
function drawTrend(canvasId,dataPoints){
  const canvas=$(canvasId);if(!canvas||!canvas.getContext)return;
  const ctx=canvas.getContext('2d');
  const W=canvas.parentElement.clientWidth;const H=120;
  canvas.width=W;canvas.height=H;
  ctx.clearRect(0,0,W,H);
  // Generate sample trend data
  const pts=24;const data=[];
  for(let i=0;i<pts;i++)data.push(Math.max(0,Math.min(1,(dataPoints/50)+Math.sin(i*.3)*.15+Math.random()*.1)));
  // Grid
  ctx.strokeStyle='#1e2a3a';ctx.lineWidth=.5;
  for(let y=0;y<H;y+=30){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
  // Line
  const grad=ctx.createLinearGradient(0,0,W,0);
  grad.addColorStop(0,'#7c6aef');grad.addColorStop(.5,'#22d3ee');grad.addColorStop(1,'#34d399');
  ctx.strokeStyle=grad;ctx.lineWidth=2;ctx.beginPath();
  data.forEach((v,i)=>{
    const x=(i/(pts-1))*W;const y=H-v*H*.8-H*.1;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();
  // Fill area
  const lastX=(pts-1)/(pts-1)*W;const lastY=H-data[pts-1]*H*.8-H*.1;
  ctx.lineTo(lastX,H);ctx.lineTo(0,H);ctx.closePath();
  const fillGrad=ctx.createLinearGradient(0,0,0,H);
  fillGrad.addColorStop(0,'rgba(124,106,239,.15)');fillGrad.addColorStop(1,'rgba(124,106,239,0)');
  ctx.fillStyle=fillGrad;ctx.fill();
  // Labels
  ctx.fillStyle='#6b7a8d';ctx.font='9px Inter,sans-serif';
  ctx.fillText('24h',4,H-4);ctx.fillText('jetzt',W-28,H-4);
}

// ==================================================
// PAGE LOADER
// ==================================================
const loaded={};
function loadPage(p){
  if(p==='styx')loadStyx();
  else if(p==='habitus')loadHabitus();
  else if(p==='mood')loadMood();
  else if(p==='modules')loadModules();
  else if(p==='settings')loadSettings();
}

// Boot
loadStyx();
setInterval(()=>{if(document.querySelector('.nav button.active')?.dataset.page==='styx')loadStyx()},30000);
</script>
</body>
</html>
