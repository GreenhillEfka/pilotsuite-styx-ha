# AI Home CoPilot — Code-Audit Februar 2026

> Automatisierte Fehleranalyse beider Repositories.

---

## Repo 1: ai-home-copilot-ha (Integration v0.3.2)

### Gefundene Fehler

| # | Datei | Zeile(n) | Typ | Schwere | Beschreibung |
|---|-------|----------|-----|---------|-------------|
| 1 | `config_flow.py` | 46-47, 56-57 | Doppelter Import | MITTEL | `DEFAULT_MEDIA_MUSIC_PLAYERS` und `DEFAULT_MEDIA_TV_PLAYERS` werden zweimal importiert |
| 2 | `api.py` | 109 | Import-Reihenfolge | NIEDRIG | `import asyncio` am Dateiende trotz Nutzung in Zeile 44 und 68 |
| 3 | `diagnostics.py` | 161 | Sicherheit | HOCH | `CONF_TOKEN` wird in Diagnostics-Output aufgenommen — trotz Redaction-Liste riskant |
| 4 | `translations/en.json`, `de.json` | Diverse | Konfig-Inkonsistenz | MITTEL | `pilotsuite_show_safety_backup_buttons`, `pilotsuite_show_dev_surface_buttons`, `pilotsuite_show_graph_bridge_buttons` fehlen im `options.step.settings.data`-Abschnitt |
| 5 | `config_snapshot_flow.py` | 49, 84 | Async-Problem | HOCH | Blockierender `open()`-Aufruf in async-Funktion ohne `async_add_executor_job()` |
| 6 | `safety_backup.py` | 69 | Lokalisierung | NIEDRIG | Hardcoded deutscher String statt Translation-Key |
| 7 | `ha_errors_digest.py` | 189 | Lokalisierung | NIEDRIG | Hardcoded deutscher String statt Translation-Key |

### Empfohlene Maßnahmen (Prio-Reihenfolge)

1. **HOCH**: Token aus Diagnostics entfernen oder durch Platzhalter ersetzen (`diagnostics.py:161`)
2. **HOCH**: Blockierenden File-I/O in `config_snapshot_flow.py` fixen — `await hass.async_add_executor_job()` verwenden
3. **MITTEL**: Doppelten Import in `config_flow.py` entfernen
4. **MITTEL**: Fehlende Translation-Keys für PilotSuite-Settings ergänzen
5. **NIEDRIG**: Hardcoded Strings in Translation-Dateien verschieben

---

## Repo 2: Home-Assistant-Copilot (Core v0.2.7)

### Gefundene Fehler

| # | Datei | Zeile(n) | Typ | Schwere | Beschreibung |
|---|-------|----------|-----|---------|-------------|
| 1 | `brain_graph/provider.py` | 14-30 | Thread-Safety | KRITISCH | Lazy-Loading Singleton ohne Lock — Race Condition bei parallelen Flask-Requests |
| 2 | `brain_graph/service.py` | 96-309 | Thread-Safety | KRITISCH | Direkter Zugriff auf `store.nodes`/`store.edges` ohne Lock, obwohl `BrainGraphStore._lock` existiert |
| 3 | `api/v1/dev.py` | 87-130 | Thread-Safety | KRITISCH | Globale `_DEV_LOG_CACHE`-Liste wird ohne Lock modifiziert |
| 4 | `api/v1/dev.py` | 91-112 | Thread-Safety | HOCH | Double-checked Locking bei `_DEV_LOG_CACHE_LOADED` ohne echten Lock |
| 5 | `api/v1/graph_ops.py` | 23-44, 119-121 | Thread-Safety | KRITISCH | Globaler `_IDEM_CACHE` Dict ohne Lock — Idempotenz kann versagen |
| 6 | `api/v1/events.py` | 13-26 | Thread-Safety | KRITISCH | Unsafe Singleton-Pattern für `EventStore` |
| 7 | `api/v1/candidates.py` | 13-24 | Thread-Safety | KRITISCH | Unsafe Singleton-Pattern für `CandidateStore` |
| 8 | `api/v1/mood.py` | 11-17 | Thread-Safety | KRITISCH | Unsafe Singleton-Pattern für Mood-Service |
| 9 | `storage/events.py` | 106-210 | Thread-Safety | KRITISCH | `EventStore._cache`, `_seen`, `_by_key` werden ohne Lock modifiziert |
| 10 | `storage/candidates.py` | 75-142 | Thread-Safety | KRITISCH | `CandidateStore`-Dicts werden ohne Lock modifiziert |
| 11 | `config.json` vs `app.py` | config:5, app:19 | Version-Mismatch | MITTEL | config.json sagt `0.2.7`, app.py Default ist `0.2.5` |
| 12 | `diagnostics_contract.py` | 22 | Unused Import | NIEDRIG | `Callable` importiert aber nie verwendet |
| 13 | `api/v1/mood.py` | 20-27 | Error Handling | MITTEL | Alle Exceptions still geschluckt bei EventStore-Import |
| 14 | `main.py` | 18-22 | Error Handling | MITTEL | Konfigurations-Fehler still ignoriert ohne Logging |

### Empfohlene Maßnahmen (Prio-Reihenfolge)

1. **KRITISCH**: Threading-Locks für **alle** globalen Datenstrukturen einführen
   - `threading.Lock()` für alle Singleton-Provider
   - `threading.RLock()` für Store-Klassen (nodes, edges, cache, seen, by_key)
   - `threading.Lock()` für _IDEM_CACHE und _DEV_LOG_CACHE
2. **KRITISCH**: Sichere Singleton-Patterns implementieren (Double-checked Locking mit echtem Lock)
3. **HOCH**: Error Logging statt stiller Exception-Behandlung
4. **MITTEL**: Version-Mismatch zwischen config.json und app.py fixen
5. **MITTEL**: `requirements.txt` erstellen für Dependency-Management
6. **NIEDRIG**: Unused Imports entfernen

---

## Gesamtbewertung

| Repo | Kritisch | Hoch | Mittel | Niedrig | Gesamt |
|------|----------|------|--------|---------|--------|
| ai-home-copilot-ha | 0 | 2 | 2 | 3 | **7** |
| Home-Assistant-Copilot | 8 | 1 | 3 | 2 | **14** |
| **Gesamt** | **8** | **3** | **5** | **5** | **21** |

### Fazit

**Repo 1 (Integration)** ist in gutem Zustand — die gefundenen Probleme sind überschaubar und leicht zu beheben.

**Repo 2 (Core)** hat ein **systemisches Thread-Safety Problem**. Da Flask mit Waitress als Multi-Threaded WSGI-Server läuft, sind die fehlenden Locks ein reales Risiko für Datenkorruption unter Last. Dies sollte vor der DeepSeek-R1 Integration behoben werden, da LLM-Calls (30s Timeout) die Thread-Contention deutlich erhöhen werden.
